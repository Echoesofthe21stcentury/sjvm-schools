<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Result Upload - SJVM</title>
  <link rel="icon" href="assets/logo.png">
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #141e30, #243b55);
      color: #fff;
      padding: 30px;
    }
    h1 {
      text-align: center;
      color: #ffd700;
    }
    select, input, button {
      padding: 8px;
      margin: 8px;
      font-size: 16px;
      border-radius: 5px;
    }
    table {
      width: 100%;
      margin-top: 15px;
      border-collapse: collapse;
    }
    th, td {
      border: 1px solid #fff;
      padding: 10px;
      text-align: center;
    }
    .pass {
      background-color: #4caf50;
    }
    .fail {
      background-color: #e53935;
    }
    .section {
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<h1>SJVM Result Upload Portal</h1>

<div class="section">
  <label>Select Branch:</label>
  <select id="branch">
    <option value="Atturu">Atturu</option>
    <option value="Bandikodigenahalli">Bandikodigenahalli</option>
  </select>

  <label>Enter Magical Code:</label>
  <input type="password" id="magicCode">
  <button onclick="verifyCode()">Enter</button>
</div>

<div id="mainForm" style="display:none;">
  <div class="section">
    <label>Select Class:</label>
    <select id="class"></select>

    <label>Select Student:</label>
    <select id="student"></select>

    <div>Register Number: <span id="regNoDisplay"></span></div>
  </div>

  <table id="resultTable">
    <thead>
      <tr>
        <th>Subject</th>
        <th>Max Marks</th>
        <th>Marks Obtained</th>
        <th>Internal Max</th>
        <th>Internal Obtained</th>
        <th>Total</th>
        <th>Grade</th>
        <th>Pass/Fail</th>
      </tr>
    </thead>
    <tbody id="subjectsBody">
      <!-- Subjects added dynamically -->
    </tbody>
  </table>

  <button onclick="addSubjectRow()">Add Subject</button>

  <div class="section">
    <label>Total Max Marks:</label>
    <input id="totalMax" type="number">

    <label>Total Obtained:</label>
    <input id="totalObtained" type="number">

    <label>Percentage:</label>
    <input id="percentage" type="text">

    <label>Final Grade:</label>
    <input id="finalGrade" type="text">

    <label>Final Result:</label>
    <select id="finalResult">
      <option>Pass</option>
      <option>Fail</option>
    </select>

    <label>Result Uploader Name:</label>
    <input id="uploader" type="text">

    <label>GitHub Token:</label>
    <input id="githubToken" type="password">

    <button onclick="submitResult()">Upload Result</button>
  </div>
</div>

<script>
const correctCodes = { "Atturu": "0903", "Bandikodigenahalli": "1103" };
let studentData = [], selectedStudent = {};

async function verifyCode() {
  const branch = document.getElementById("branch").value;
  const code = document.getElementById("magicCode").value;
  if (code === correctCodes[branch]) {
    document.getElementById("mainForm").style.display = "block";
    await loadStudents();
  } else {
    alert("❌ Incorrect Magical Code");
  }
}

function addSubjectRow() {
  const tbody = document.getElementById("subjectsBody");
  const row = document.createElement("tr");

  const subjects = ["Subject", "Max", "Obtained", "Internal Max", "Internal Obt", "Total", "Grade", "Status"];
  subjects.forEach((_, i) => {
    const td = document.createElement("td");
    if (i < 6) {
      const input = document.createElement("input");
      input.type = "text";
      input.oninput = () => updateRowStatus(row);
      td.appendChild(input);
    } else if (i === 6) {
      const grade = document.createElement("input");
      td.appendChild(grade);
    } else {
      const passFail = document.createElement("select");
      passFail.innerHTML = "<option>Pass</option><option>Fail</option>";
      td.appendChild(passFail);
    }
    row.appendChild(td);
  });

  tbody.appendChild(row);
}

function updateRowStatus(row) {
  const totalTd = row.children[5];
  const max = parseFloat(row.children[1].children[0].value) || 0;
  const obt = parseFloat(row.children[2].children[0].value) || 0;
  const internalMax = parseFloat(row.children[3].children[0].value) || 0;
  const internalObt = parseFloat(row.children[4].children[0].value) || 0;

  totalTd.children[0].value = obt + internalObt;
  const status = row.children[7].children[0];
  row.className = (obt + internalObt) >= (0.4 * (max + internalMax)) ? "pass" : "fail";
}

async function loadStudents() {
  const branch = document.getElementById("branch").value;
  const classList = new Set();
  const res = await fetch('https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_register.json');
  studentData = await res.json();

  document.getElementById("class").innerHTML = "";
  document.getElementById("student").innerHTML = "";

  studentData.forEach(s => {
    if (s.branch === branch) classList.add(s.class);
  });

  [...classList].forEach(cls => {
    const option = document.createElement("option");
    option.value = option.textContent = cls;
    document.getElementById("class").appendChild(option);
  });

  document.getElementById("class").addEventListener("change", updateStudentDropdown);
  document.getElementById("student").addEventListener("change", () => {
    selectedStudent = studentData.find(s => s.name === document.getElementById("student").value);
    document.getElementById("regNoDisplay").textContent = selectedStudent.register_number;
  });

  updateStudentDropdown();
}

function updateStudentDropdown() {
  const cls = document.getElementById("class").value;
  const branch = document.getElementById("branch").value;
  const studentSelect = document.getElementById("student");

  studentSelect.innerHTML = "";
  studentData.filter(s => s.class === cls && s.branch === branch).forEach(stu => {
    const opt = document.createElement("option");
    opt.value = opt.textContent = stu.name;
    studentSelect.appendChild(opt);
  });
}

async function submitResult() {
  const tableRows = document.querySelectorAll("#subjectsBody tr");
  const subjects = [];
  tableRows.forEach(tr => {
    const cells = tr.querySelectorAll("td");
    subjects.push({
      subject: cells[0].children[0].value,
      max: cells[1].children[0].value,
      obtained: cells[2].children[0].value,
      internalMax: cells[3].children[0].value,
      internalObt: cells[4].children[0].value,
      total: cells[5].children[0].value,
      grade: cells[6].children[0].value,
      status: cells[7].children[0].value
    });
  });

  const result = {
    student: selectedStudent.name,
    register_number: selectedStudent.register_number,
    class: selectedStudent.class,
    branch: selectedStudent.branch,
    exam: document.getElementById("finalGrade").value,
    subjects,
    overall: {
      totalMax: document.getElementById("totalMax").value,
      totalObtained: document.getElementById("totalObtained").value,
      percentage: document.getElementById("percentage").value,
      finalGrade: document.getElementById("finalGrade").value,
      result: document.getElementById("finalResult").value
    },
    uploaded_by: document.getElementById("uploader").value,
    date: new Date().toLocaleString()
  };

  const token = document.getElementById("githubToken").value;
  const filename = `data/results/${selectedStudent.register_number}.json`;

  const response = await fetch(`https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filename}`, {
    method: 'PUT',
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: `Result upload for ${selectedStudent.name}`,
      content: btoa(unescape(encodeURIComponent(JSON.stringify(result, null, 2)))),
      sha: await getFileSHA(filename, token)
    })
  });

  if (response.ok) {
    alert("✅ Result uploaded successfully.");
  } else {
    alert("❌ Failed to upload result.");
  }
}

async function getFileSHA(filename, token) {
  const res = await fetch(`https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filename}`, {
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  return data.sha || undefined;
}
</script>

</body>
</html>
