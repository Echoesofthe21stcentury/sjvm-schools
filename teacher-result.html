<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Student Result</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f4f8;
      padding: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 12px rgba(0, 0, 0, 0.1);
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, select, button {
      width: 100%;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #007bff;
      color: white;
      font-weight: bold;
    }
    button:hover {
      background-color: #0056b3;
    }
    .subject-container {
      margin-top: 20px;
    }
    .subject-box {
      border: 2px solid #ccc;
      padding: 10px;
      border-radius: 10px;
      margin-bottom: 10px;
    }
    .pass {
      background: #d4edda;
    }
    .fail {
      background: #f8d7da;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Student Result</h2>
    <div class="form-group">
      <label for="branch">Select Branch</label>
      <select id="branch">
        <option value="">-- Select Branch --</option>
        <option value="Bandikodigenahalli">Bandikodigenahalli</option>
        <option value="Atturu">Atturu</option>
      </select>
    </div>
    <div class="form-group">
      <label for="code">Enter Secret Code</label>
      <input type="password" id="code" placeholder="Secret Code">
    </div>
    <div class="form-group">
      <label for="updater">Updater Name</label>
      <input type="text" id="updater" placeholder="Enter your name">
    </div>
    <div class="form-group">
      <button onclick="verifyCode()">Next</button>
    </div>

    <div id="classSelection" style="display:none;">
      <div class="form-group">
        <label for="classSelect">Select Class</label>
        <select id="classSelect" onchange="loadStudents()"></select>
      </div>
      <div class="form-group">
        <label for="studentSelect">Select Student</label>
        <select id="studentSelect" onchange="populateStudentDetails()"></select>
      </div>
      <div class="form-group">
        <label for="regNo">Register Number</label>
        <input type="text" id="regNo" disabled>
      </div>
      <div class="form-group">
        <label for="exam">Examination</label>
        <input type="text" id="exam" disabled>
      </div>

      <div class="subject-container" id="subjects"></div>

      <div class="form-group">
        <label for="totalMax">Total Max Marks</label>
        <input type="number" id="totalMax">
      </div>
      <div class="form-group">
        <label for="totalObtained">Total Marks Obtained</label>
        <input type="number" id="totalObtained">
      </div>
      <div class="form-group">
        <label for="grade">Final Grade</label>
        <input type="text" id="grade">
      </div>
      <div class="form-group">
        <label for="percentage">Percentage</label>
        <input type="number" id="percentage">
      </div>
      <div class="form-group">
        <label for="result">Final Result (Pass/Fail)</label>
        <select id="result">
          <option value="Pass">Pass</option>
          <option value="Fail">Fail</option>
        </select>
      </div>

      <div class="form-group">
        <button onclick="uploadResult()">Upload Result</button>
      </div>
    </div>
  </div>

  <script>
    const secretCodes = {
      'Bandikodigenahalli': '1103',
      'Atturu': '0903'
    };
    const subjects = ["Kannada", "English", "Hindi", "Mathematics", "Science", "Social"];
    let students = [];

    function verifyCode() {
      const branch = document.getElementById('branch').value;
      const code = document.getElementById('code').value;

      if (secretCodes[branch] === code) {
        fetch('data/student_register.json')
          .then(res => res.json())
          .then(data => {
            students = data.filter(s => s.branch === branch);
            const classSelect = document.getElementById('classSelect');
            const uniqueClasses = [...new Set(students.map(s => s.class))];
            classSelect.innerHTML = '<option value="">Select Class</option>' + uniqueClasses.map(c => `<option value="${c}">${c}</option>`).join('');
            document.getElementById('classSelection').style.display = 'block';
          });
      } else {
        alert("‚ùå Incorrect secret code.");
      }
    }

    function loadStudents() {
      const selectedClass = document.getElementById('classSelect').value;
      const filteredStudents = students.filter(s => s.class === selectedClass);
      const studentSelect = document.getElementById('studentSelect');
      studentSelect.innerHTML = '<option value="">Select Student</option>' + filteredStudents.map(s => `<option value="${s.regno}">${s.name}</option>`).join('');
    }

    function populateStudentDetails() {
      const regno = document.getElementById('studentSelect').value;
      const student = students.find(s => s.regno === regno);
      if (student) {
        document.getElementById('regNo').value = student.regno;
        document.getElementById('exam').value = student.exam;
        const subjectContainer = document.getElementById('subjects');
        subjectContainer.innerHTML = '';
        subjects.forEach(sub => {
          subjectContainer.innerHTML += `
            <div class="subject-box" id="${sub}-box">
              <h4>${sub}</h4>
              <label>Max Marks: <input type="number" id="${sub}-max"></label>
              <label>Marks Obtained: <input type="number" id="${sub}-obt"></label>
              <label>Internal Max: <input type="number" id="${sub}-imax"></label>
              <label>Internal Obtained: <input type="number" id="${sub}-iobt"></label>
              <label>Total Marks: <input type="number" id="${sub}-total"></label>
              <label>Grade: <input type="text" id="${sub}-grade"></label>
              <label>Result:
                <select id="${sub}-result">
                  <option value="Pass">Pass</option>
                  <option value="Fail">Fail</option>
                </select>
              </label>
            </div>`;
        });
      }
    }

    async function uploadResult() {
      const updater = document.getElementById('updater').value;
      const regNo = document.getElementById('regNo').value;
      const exam = document.getElementById('exam').value;

      const finalResult = {
        updater,
        regNo,
        exam,
        subjects: {},
        totalMax: document.getElementById('totalMax').value,
        totalObtained: document.getElementById('totalObtained').value,
        grade: document.getElementById('grade').value,
        percentage: document.getElementById('percentage').value,
        result: document.getElementById('result').value
      };

      subjects.forEach(sub => {
        const result = document.getElementById(`${sub}-result`).value;
        finalResult.subjects[sub] = {
          max: document.getElementById(`${sub}-max`).value,
          obtained: document.getElementById(`${sub}-obt`).value,
          internalMax: document.getElementById(`${sub}-imax`).value,
          internalObtained: document.getElementById(`${sub}-iobt`).value,
          total: document.getElementById(`${sub}-total`).value,
          grade: document.getElementById(`${sub}-grade`).value,
          result
        };
        document.getElementById(`${sub}-box`).className = `subject-box ${result === "Pass" ? "pass" : "fail"}`;
      });

      const token = prompt("üîê Enter your GitHub Personal Access Token:");
      const repo = "Echoesofthe21stcentury/sjvm-schools";
      const path = "data/results.json";
      const apiUrl = `https://api.github.com/repos/${repo}/contents/${path}`;

      const existing = await fetch(apiUrl, {
        headers: { Authorization: `token ${token}` }
      });

      let existingContent = [];
      let sha = null;
      if (existing.ok) {
        const json = await existing.json();
        existingContent = JSON.parse(atob(json.content));
        sha = json.sha;
      }

      existingContent.push(finalResult);
      const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(existingContent, null, 2))));

      const uploadRes = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Uploaded result for ${regNo}`,
          content: updatedContent,
          sha
        })
      });

      const uploadData = await uploadRes.json();
      if (uploadData.content) {
        alert("‚úÖ Result uploaded successfully.");
      } else {
        alert("‚ùå Failed to upload result.");
        console.error(uploadData);
      }
    }
  </script>
</body>
</html>
