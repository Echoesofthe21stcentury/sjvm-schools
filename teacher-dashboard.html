<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="auth-check.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f8fc;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 20px;
      text-align: center;
    }
    nav {
      background-color: #0059b3;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    nav a {
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      background-color: #003366;
    }
    .container {
      padding: 30px;
      max-width: 900px;
      margin: auto;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #003366;
      color: white;
    }
    select, input, textarea, button {
      padding: 8px;
      margin-top: 10px;
      width: 100%;
      box-sizing: border-box;
    }
    .logout {
      text-align: center;
      margin-top: 30px;
    }
    .logout button {
      background-color: #b30000;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .logout button:hover {
      background-color: #800000;
    }
  </style>
</head>
<body>
  <header>
    <h1>üë©‚Äçüè´ SJVM Teacher Dashboard</h1>
  </header>

  <nav>
    <a href="#" onclick="loadAttendanceForm()">Mark Attendance</a>
    <a href="#" onclick="showHomeworkForm()">Upload Homework</a>
    <a href="#" onclick="viewCirculars()">View Circulars</a>
  </nav>

  <div class="container" id="dashboardContent">
    <p>Welcome! Please select an option from the menu above.</p>
  </div>

  <div class="logout">
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
    const attendanceURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";
    const homeworkURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";
    const circularsURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/circulars.json";
    const branch = localStorage.getItem("branch");

    function logout() {
      localStorage.clear();
      window.location.href = "userlogin.html";
    }

    async function loadAttendanceForm() {
      const res = await fetch(usersURL);
      const data = await res.json();
      const studentData = data["Student"];

      let classOptions = Object.keys(studentData).map(cls => `<option value="${cls}">${cls}</option>`).join("");

      document.getElementById("dashboardContent").innerHTML = `
        <h2>üìÖ Mark Attendance</h2>
        <label>Date:</label><input type="date" id="attDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Class:</label><select id="attClass">${classOptions}</select>
        <button onclick="generateAttendance()">Load Students</button>
        <form id="attForm"></form>
      `;
    }

    async function generateAttendance() {
      const cls = document.getElementById("attClass").value;
      const res = await fetch(usersURL);
      const data = await res.json();
      const students = data["Student"]?.[cls];
      let html = `<h3>Class: ${cls} | Branch: ${branch}</h3><table><tr><th>Student ID</th><th>Name</th><th>Status</th></tr>`;

      for (let id in students) {
        html += `
          <tr>
            <td>${id}</td>
            <td>${students[id].name}</td>
            <td>
              <select name="${id}" onchange="updateStatusColor(this)">
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
              </select>
            </td>
          </tr>`;
      }

      html += `</table><br><button onclick="submitAttendance(event)">Submit Attendance</button>`;
      document.getElementById("attForm").innerHTML = html;

      setTimeout(() => {
        document.querySelectorAll("#attForm select").forEach(select => updateStatusColor(select));
      }, 0);
    }

    function updateStatusColor(selectEl) {
      const td = selectEl.parentElement;
      if (selectEl.value === "Present") {
        td.style.backgroundColor = "#c6f6c4"; // light green
      } else if (selectEl.value === "Absent") {
        td.style.backgroundColor = "#f7c6c7"; // light red
      } else {
        td.style.backgroundColor = "";
      }
    }

    async function submitAttendance(e) {
      e.preventDefault();
      const form = document.getElementById("attForm");
      const selects = form.querySelectorAll("select");
      const attendance = {};
      selects.forEach(sel => {
        attendance[sel.name] = sel.value;
      });

      const date = document.getElementById("attDate").value;
      const cls = document.getElementById("attClass").value;
      const token = prompt("üîê Enter your GitHub PAT:");

      const headers = {
        Authorization: `token ${token}`,
        Accept: "application/vnd.github.v3+json"
      };

      try {
        const res = await fetch(attendanceURL, { headers });
        const file = await res.json();
        const sha = file.sha;
        const content = atob(file.content);
        let data = JSON.parse(content);

        if (!data[date]) data[date] = {};
        if (!data[date][cls]) data[date][cls] = {};
        if (data[date][cls][branch]) {
          alert(`‚ö†Ô∏è Attendance already submitted for ${cls} on ${date} (${branch}).`);
          return;
        }

        data[date][cls][branch] = attendance;

        const updatedContent = btoa(JSON.stringify(data, null, 2));

        const commit = await fetch(attendanceURL, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: `üìÖ Attendance for ${cls} (${branch}) on ${date}`,
            content: updatedContent,
            sha
          })
        });

        if (commit.ok) {
          alert("‚úÖ Attendance submitted!");
          document.getElementById("attForm").innerHTML = "";
        } else {
          alert("‚ùå Failed to save attendance.");
        }

      } catch (err) {
        alert("‚ùå Error: " + err.message);
      }
    }

    function showHomeworkForm() {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("dashboardContent").innerHTML = `
        <h2>üìö Upload Homework</h2>
        <form id="homeworkForm" onsubmit="submitHomework(event)">
          <label>Class:</label>
          <select id="class">
            <option value="PKG">PKG</option>
            <option value="LKG">LKG</option>
            <option value="UKG">UKG</option>
            <option value="Class 1">Class 1</option>
            <option value="Class 2">Class 2</option>
            <option value="Class 3">Class 3</option>
            <option value="Class 4">Class 4</option>
            <option value="Class 5">Class 5</option>
            <option value="Class 6">Class 6</option>
            <option value="Class 7">Class 7</option>
            <option value="Class 8">Class 8</option>
            <option value="Class 9">Class 9</option>
            <option value="Class 10">Class 10</option>
          </select>
          <label>Subject:</label>
          <input type="text" id="subject" />
          <label>Description:</label>
          <textarea id="description" rows="4"></textarea>
          <br><button type="submit">Upload</button>
        </form>
      `;
    }

    async function submitHomework(e) {
      e.preventDefault();
      const selectedClass = document.getElementById("class").value;
      const subject = document.getElementById("subject").value.trim();
      const description = document.getElementById("description").value.trim();
      const date = new Date().toISOString().split("T")[0];
      const token = prompt("üîê Enter your GitHub PAT:");

      if (!selectedClass || !subject || !description) {
        alert("‚ö†Ô∏è Fill all fields.");
        return;
      }

      const headers = {
        Authorization: `token ${token}`,
        Accept: "application/vnd.github.v3+json"
      };

      try {
        const res = await fetch(homeworkURL, { headers });
        const file = await res.json();
        const sha = file.sha;
        const content = atob(file.content);
        let data = JSON.parse(content);

        if (!data[selectedClass]) data[selectedClass] = {};
        if (!data[selectedClass][branch]) data[selectedClass][branch] = [];

        data[selectedClass][branch].push({ date, subject, description });

        const updatedContent = btoa(JSON.stringify(data, null, 2));

        const commit = await fetch(homeworkURL, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: `üìù Homework for ${selectedClass} (${branch})`,
            content: updatedContent,
            sha
          })
        });

        if (commit.ok) {
          alert("‚úÖ Homework uploaded!");
          document.getElementById("homeworkForm").reset();
        } else {
          alert("‚ùå Upload failed.");
        }
      } catch (err) {
        alert("‚ùå Error: " + err.message);
      }
    }

    async function viewCirculars() {
      try {
        const res = await fetch(circularsURL);
        const data = await res.json();
        const circulars = data?.[branch] || [];

        if (circulars.length === 0) {
          document.getElementById("dashboardContent").innerHTML = "<p>No circulars available.</p>";
          return;
        }

        const list = circulars.map(c => `<li><strong>${c.date}</strong>: ${c.message}</li>`).join("");

        document.getElementById("dashboardContent").innerHTML = `
          <h3>üì¢ Circulars for ${branch}</h3>
          <ul>${list}</ul>
        `;
      } catch {
        document.getElementById("dashboardContent").innerHTML = "<p>Error loading circulars.</p>";
      }
    }
  </script>
</body>
</html>
