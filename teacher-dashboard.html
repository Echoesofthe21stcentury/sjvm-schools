<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; }
    header { background: #003366; color: white; padding: 20px; position: relative; }
    .profile-circle { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right:10px; }
    nav { background: #0059b3; display: flex; justify-content:center; flex-wrap: wrap; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; font-weight: bold; }
    nav a:hover { background: #003366; }
    .container { max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { padding:8px; border:1px solid #ccc; text-align:center; }
    th { background: #e0ebff; }
    input[type=number],select { padding:6px; width:100%; box-sizing:border-box; }
    button { padding:10px 15px; margin-top:10px; cursor:pointer; }
    .logout { text-align:center; margin:20px;}
    .logout button { background:#b30000; color:white; border:none; padding:10px 20px; border-radius:6px; }
    .logout button:hover { background:#800000; }
    @media(max-width:600px){
      table,th,td{font-size:12px;}
      .profile-circle{width:30px;height:30px;}
    }
  </style>
</head>
<body>
<header>
  üë©‚Äçüè´ SJVM Teacher Dashboard
  <div style="position:absolute; top:15px; right:20px;">
    <img id="teacherPhoto" class="profile-circle" />
    <span id="usernameDisplay"></span>
    <button onclick="logout()" style="background: crimson; color:white; border:none; padding:6px 12px; margin-left:10px; border-radius:5px">Logout</button>
  </div>
</header>

<nav>
  <a href="#" onclick="showProfile()">üë§ Profile</a>
  <a href="#" onclick="markAttendance()">üìÖ Mark Attendance</a>
  <a href="#" onclick="uploadResult()">üßæ Upload Result</a>
</nav>

<div class="container" id="dashboardContent">
  <p>Select a menu option.</p>
</div>

<div class="logout">
  <button onclick="logout()">Logout</button>
</div>

<script>
const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
const attendanceAPI = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";
const resultAPIBase = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/results/";

const username = localStorage.getItem("username");
const branch = localStorage.getItem("branch");
document.getElementById("usernameDisplay").innerText = username;

// Load teacher photo
fetch(usersURL).then(r => r.json()).then(data => {
  const t = Object.values(data.Teacher || {}).flatMap(o => Object.values(o)).find(u => u.name === username);
  const photo = (t?.photo || "").trim();
  document.getElementById("teacherPhoto").src = photo ? `https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/${photo}` : 
  "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/SJVM%20logo%20empowering%20mankind%20without%20background.png";
});

function logout() {
  localStorage.clear();
  window.location.href = "userlogin.html";
}

function showProfile() {
  fetch(usersURL).then(res => res.json()).then(data => {
    const teacher = Object.values(data.Teacher[branch] || {}).find(t => t.name === username);
    const photo = teacher?.photo ? `https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/${teacher.photo}` :
      "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/SJVM%20logo%20empowering%20mankind%20without%20background.png";
    document.getElementById("dashboardContent").innerHTML = teacher ? `
      <h2>üë§ Profile</h2>
      <img src="${photo}" alt="Photo" style="width:100px;height:100px;border-radius:50%;margin-bottom:10px;"><br>
      <p><strong>Name:</strong> ${teacher.name}</p>
      <p><strong>Branch:</strong> ${teacher.branch || branch}</p>
    ` : "<p>Teacher data not found.</p>";
  });
}

async function markAttendance() {
  const res = await fetch(usersURL);
  const data = await res.json();
  const students = data.Student || {};
  let html = `<h2>üìÖ Mark Attendance</h2><form id="attForm"><label>Date:</label><input type="date" id="attDate" required><table><tr><th>Name</th><th>Class</th><th>Status</th></tr>`;

  Object.entries(students).forEach(([cls, stuList]) => {
    Object.entries(stuList).forEach(([id, s]) => {
      if (s.branch === branch) {
        html += `<tr style="background:#fff">
          <td>${s.name}</td><td>${cls}</td>
          <td>
            <select name="${id}_${cls}">
              <option value="Present" style="background:#28FF20">Present</option>
              <option value="Absent" style="background:#c30010">Absent</option>
            </select>
          </td>
        </tr>`;
      }
    });
  });

  html += `</table><br><button type="submit">‚úÖ Submit Attendance</button></form><p id="attStatus"></p>`;
  document.getElementById("dashboardContent").innerHTML = html;

  document.getElementById("attForm").onsubmit = async function (e) {
    e.preventDefault();
    const form = new FormData(this);
    const date = document.getElementById("attDate").value;
    if (!date) return alert("Please select date");
    const token = prompt("GitHub PAT:");
    const res = await fetch(attendanceAPI, { headers: { Authorization: `token ${token}` } }).then(r => r.json());
    const data = JSON.parse(atob(res.content));
    data[date] = data[date] || {};
    for (let [key, val] of form.entries()) {
      const [id, cls] = key.split("_");
      data[date][cls] = data[date][cls] || {};
      data[date][cls][branch] = data[date][cls][branch] || {};
      data[date][cls][branch][id] = val;
    }
    await fetch(attendanceAPI, {
      method: "PUT",
      headers: { Authorization: `token ${token}` },
      body: JSON.stringify({
        message: `Marked attendance ${date}`,
        content: btoa(JSON.stringify(data, null, 2)),
        sha: res.sha
      })
    });
    document.getElementById("attStatus").innerText = "‚úÖ Attendance marked!";
  };
}

async function uploadResult() {
  const res = await fetch(usersURL);
  const data = await res.json();
  const students = data.Student || {};
  const clsList = Object.keys(students);
  const subjects = ["Kannada","English","Hindi","Mathematics","EVS","Science","Social Science"];
  document.getElementById("dashboardContent").innerHTML = `
    <h2>üßæ Upload Result</h2>
    <label>Class:</label><select id="classSel">${clsList.map(c => `<option value="${c}">${c}</option>`)}</select><br><br>
    <label>Exam:</label><select id="examSel"><option>FA1</option><option>FA2</option><option>SA1</option><option>FA3</option><option>FA4</option><option>SA2</option></select><br><br>
    <label>Student:</label><select id="stuSel"></select><br><br>
    <table><tr><th>Subject</th><th>Max</th><th>Obtained</th><th>Internal</th><th>Total</th><th>Grade</th></tr>
    ${subjects.map(s => `
      <tr>
        <td>${s}</td>
        <td><input type="number" id="max_${s}" value="80" oninput="calc('${s}')"></td>
        <td><input type="number" id="obt_${s}" oninput="calc('${s}')"></td>
        <td><input type="number" id="int_${s}" value="20" oninput="calc('${s}')"></td>
        <td><input type="number" id="tot_${s}" readonly></td>
        <td><input type="text" id="grade_${s}"></td>
      </tr>`).join("")}</table><br>
    <label>Status:</label><select id="status"><option>Pass</option><option>Fail</option></select><br><br>
    <button onclick="submitResult()">üì§ Submit</button><p id="resStatus"></p>
  `;

  document.getElementById("classSel").onchange = function() {
    const cls = this.value;
    const stuOpts = Object.entries(students[cls] || {}).filter(([_, s]) => s.branch === branch).map(([id, s]) => `<option value="${id}">${s.name} (${id})</option>`).join("");
    document.getElementById("stuSel").innerHTML = stuOpts;
  };
}

function calc(sub) {
  const o = +document.getElementById(`obt_${sub}`).value || 0;
  const i = +document.getElementById(`int_${sub}`).value || 0;
  document.getElementById(`tot_${sub}`).value = o + i;
}

async function submitResult() {
  const studentId = document.getElementById("stuSel").value;
  const className = document.getElementById("classSel").value;
  const examType = document.getElementById("examSel").value;
  const status = document.getElementById("status").value;
  const token = prompt("GitHub PAT:");
  const subs = ["Kannada","English","Hindi","Mathematics","EVS","Science","Social Science"];
  let totalMarks = 0, maxMarks = 0;
  const marks = {};
  subs.forEach(sub => {
    const ob = +document.getElementById(`obt_${sub}`).value || 0;
    const mx = +document.getElementById(`max_${sub}`).value || 0;
    const intl = +document.getElementById(`int_${sub}`).value || 0;
    const grd = document.getElementById(`grade_${sub}`).value || "-";
    const tot = ob + intl;
    marks[sub] = {obtained: ob, maxMarks: mx, internal: intl, total: tot, grade: grd};
    totalMarks += tot;
    maxMarks += mx + 20;
  });
  const percentage = ((totalMarks / maxMarks) * 100).toFixed(2);
  const final = {
    studentId, class: className, examType, subjects: marks,
    totalMarks, maxMarks, percentage, finalGrade: "-", status
  };
  const filename = `${examType}_${studentId}.json`;
  await fetch(resultAPIBase + filename, {
    method: "PUT", headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: `Result for ${studentId}`, content: btoa(JSON.stringify(final, null, 2))
    })
  });
  document.getElementById("resStatus").innerText = "‚úÖ Result uploaded!";
}
</script>

</body>
</html>
