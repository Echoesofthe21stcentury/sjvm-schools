<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="auth-check.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; }
    header { background: #003366; color: white; padding: 20px; position: relative; }
    .profile-circle { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right:10px; }
    nav { background: #0059b3; display: flex; justify-content:center; flex-wrap: wrap; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; font-weight: bold; }
    nav a:hover { background: #003366; }
    .container { max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { padding:8px; border:1px solid #ccc; text-align:center; }
    th { background: #e0ebff; }
    input[type=number],select { padding:6px; width:100%; box-sizing:border-box; }
    button { padding:10px 15px; margin-top:10px; cursor:pointer; }
    .logout { text-align:center; margin:20px;}
    .logout button { background:#b30000; color:white; border:none; padding:10px 20px; border-radius:6px; }
    .logout button:hover { background:#800000; }
    @media(max-width:600px){
      table,th,td{font-size:12px;}
      .profile-circle{width:30px;height:30px;}
    }
  </style>
</head>
<body>
<header>
  üë©‚Äçüè´ SJVM Teacher Dashboard
  <div style="position:absolute; top:15px; right:20px;">
    <img id="teacherPhoto" class="profile-circle"><span id="usernameDisplay"></span>
    <button onclick="logout()" style="background: crimson; color:white; border:none; padding:6px 12px; margin-left:10px; border-radius:5px">Logout</button>
  </div>
</header>

<nav>
  <a href="#" onclick="markAttendance()">üìÖ Mark Attendance</a>
  <a href="#" onclick="uploadHomework()">üìö Upload Homework</a>
  <a href="#" onclick="uploadResult()">üßæ Upload Result</a>
</nav>

<div class="container" id="dashboardContent">
  <p>Select a menu option.</p>
</div>

<div class="logout">
  <button onclick="logout()">Logout</button>
</div>

<script>
  const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
  const homeworkAPI = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";
  const resultAPIBase = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/results/";
  const resultListAPI = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/results.json";

  const username = localStorage.getItem("username");
  const branch = localStorage.getItem("branch");
  document.getElementById("usernameDisplay").innerText = username;

  fetch(usersURL)
    .then(r=>r.json())
    .then(data=>{
      const t = Object.values(data.Teacher || {}).flatMap(o=>Object.values(o)).find(u=>u.name===username);
      const photo = t?.photo?.trim() || "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/SJVM%20logo%20empowering%20mankind%20without%20background.png";
      document.getElementById("teacherPhoto").src = photo;
    });

  function logout(){localStorage.clear();window.location.href="userlogin.html";}

  function markAttendance(){
    document.getElementById("dashboardContent").innerHTML = '<h2>üìÖ Mark Attendance</h2><p>Coming soon!</p>';
  }

  async function uploadHomework() {
    const subs = ["Kannada","English","Mathematics","Science","Social Science"];
    document.getElementById("dashboardContent").innerHTML = `
      <h2>üìö Upload Homework</h2>
      <label>Class:</label><input id="hwClass"><br><br>
      <label>Subject:</label><select id="hwSubject">${subs.map(s=>`<option>${s}</option>`)}</select><br><br>
      <label>Task:</label><textarea id="hwTask" rows="3" style="width:100%"></textarea><br><br>
      <label>Due Date:</label><input id="hwDue" type="date"><br><br>
      <button onclick="submitHomework()">Submit</button>
      <p id="hwStatus"></p>`;
  }

  async function submitHomework() {
    const cls = document.getElementById("hwClass").value.trim();
    const sub = document.getElementById("hwSubject").value;
    const task = document.getElementById("hwTask").value.trim();
    const due = document.getElementById("hwDue").value;
    const token = prompt("GitHub PAT:");
    if (!cls||!sub||!task||!due||!token) return alert("All fields required");
    const r = await fetch(homeworkAPI,{ headers:{Authorization:`token ${token}`}}).then(r=>r.json());
    const data = JSON.parse(atob(r.content));
    data[cls] = data[cls]||[];
    data[cls].push({subject:sub,task,dueDate:due});
    await fetch(homeworkAPI,{
      method:"PUT",headers:{Authorization:`token ${token}`},
      body: JSON.stringify({message:"Homework update",content:btoa(JSON.stringify(data,null,2)),sha:r.sha})
    });
    document.getElementById("hwStatus").innerText="‚úÖ Homework uploaded!";
  }

  async function uploadResult(){
    const r = await fetch(usersURL).then(r=>r.json());
    window.studentData = r.Student;
    const clsList = Object.keys(r.Student);
    document.getElementById("dashboardContent").innerHTML = `
      <h2>üßæ Upload Result</h2>
      <label>Class:</label><select id="classSelect"><option>--Select--</option>${clsList.map(c=>`<option>${c}</option>`)}</select><br><br>
      <label>Exam:</label><select id="examType"><option>FA1</option><option>FA2</option><option>SA1</option><option>FA3</option><option>FA4</option><option>SA2</option></select><br><br>
      <label>Student:</label><select id="studentSelect"><option>Select class...</option></select><br><br>
      <table><thead><tr><th>Subject</th><th>Obtained</th><th>Max</th><th>Internal</th><th>Total</th><th>Grade</th></tr></thead>
        <tbody>${["Kannada","English","Hindi","Mathematics","EVS","Science","Social Science"].map(sub=>`
          <tr>
            <td>${sub}</td>
            <td><input type="number" id="ob_${sub}" oninput="calc('${sub}')"></td>
            <td><input type="number" id="max_${sub}" value="80" oninput="calc('${sub}')"></td>
            <td><input type="number" id="int_${sub}" value="20" oninput="calc('${sub}')"></td>
            <td><input type="number" id="total_${sub}" readonly></td>
            <td><input type="text" id="grade_${sub}"></td>
          </tr>`).join("")}
        </tbody></table><br>
      <label>Status:</label><select id="status"><option>Pass</option><option>Fail</option></select><br><br>
      <button onclick="submitResult()">Submit</button><p id="resultStatus"></p>`;
    document.getElementById("classSelect").addEventListener("change", e => {
      const stu = studentData[e.target.value] || {};
      const sel = document.getElementById("studentSelect");
      sel.innerHTML = Object.entries(stu)
        .filter(([_,s]) => s.branch === branch)
        .map(([id,s]) => `<option value="${id}">${s.name} (${id})</option>`).join("");
    });
  }

  function calc(sub) {
    const ob = +document.getElementById(`ob_${sub}`).value || 0;
    const mx = +document.getElementById(`max_${sub}`).value || 0;
    const intl = +document.getElementById(`int_${sub}`).value || 0;
    document.getElementById(`total_${sub}`).value = ob + intl;
  }

  async function submitResult(){
    const studentId = document.getElementById("studentSelect").value;
    const className = document.getElementById("classSelect").value;
    const examType = document.getElementById("examType").value;
    const status = document.getElementById("status").value;
    const token = prompt("GitHub PAT:");
    if (!studentId || !className || !examType || !token) return alert("All fields required");

    const subs = ["Kannada","English","Hindi","Mathematics","EVS","Science","Social Science"];
    const marks = {};
    let totalMarks = 0, maxMarks = 0;

    subs.forEach(sub=>{
      const ob = +document.getElementById(`ob_${sub}`).value || 0;
      const mx = +document.getElementById(`max_${sub}`).value || 0;
      const intl = +document.getElementById(`int_${sub}`).value || 0;
      const grade = document.getElementById(`grade_${sub}`).value || "-";
      const tot = ob + intl;
      marks[sub] = {obtained:ob, maxMarks:mx, internal:intl, internalMax:20, total:tot, grade};
      totalMarks += tot;
      maxMarks += mx + 20;
    });

    const percentage = ((totalMarks / maxMarks) * 100).toFixed(2);
    const finalData = {studentId, class:className, examType, subjects:marks, totalMarks, maxMarks, percentage, finalGrade:"-", status};

    // Upload per student
    const fn = `${examType}_${studentId}.json`;
    await fetch(resultAPIBase + fn, { method:"PUT", headers:{Authorization:`token ${token}`}, body: JSON.stringify({message:`Result for ${studentId}`, content:btoa(JSON.stringify(finalData, null, 2))}) });

    document.getElementById("resultStatus").innerText="‚úÖ Result uploaded!";
  }
</script>

</body>
</html>
