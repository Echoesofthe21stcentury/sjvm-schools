<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Student Results</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f1f4f7;
      padding: 20px;
    }
    select, input, button {
      margin: 10px;
      padding: 8px;
    }
    .section {
      margin-bottom: 20px;
    }
    .subject-box {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      background: #fff;
    }
  </style>
</head>
<body>
  <h2>Student Result Upload</h2>

  <div class="section">
    <label>Branch:</label>
    <select id="branch">
      <option value="">Select Branch</option>
      <option value="Bandikodigenahalli">Bandikodigenahalli</option>
      <option value="Atturu Layout">Atturu Layout</option>
    </select>
  </div>

  <div class="section" id="step2" style="display:none;">
    <label>Teacher/Updater Name:</label>
    <input type="text" id="updaterName" />
  </div>

  <div class="section" id="step3" style="display:none;">
    <label>Class:</label>
    <select id="studentClass">
      <option value="">Select Class</option>
      <option>Class 1</option><option>Class 2</option><option>Class 3</option>
      <option>Class 4</option><option>Class 5</option><option>Class 6</option>
      <option>Class 7</option><option>Class 8</option><option>Class 9</option>
      <option>Class 10</option>
    </select>
  </div>

  <div class="section" id="step4" style="display:none;">
    <label>Select Student:</label>
    <select id="studentName"></select>
  </div>

  <div class="section" id="step5" style="display:none;">
    <p><strong>Register No:</strong> <span id="regno"></span></p>
    <p><strong>Exam:</strong> <span id="exam">FA1</span></p>
  </div>

  <div id="marksForm" style="display:none;">
    <h3>Enter Subject Marks</h3>
    <div id="subjects"></div>

    <div>
      <label>Total Max Marks:</label>
      <input type="number" id="totalMax" />
      <label>Total Obtained:</label>
      <input type="number" id="totalObtained" />
      <label>Final Grade:</label>
      <input type="text" id="finalGrade" />
      <label>Percentage:</label>
      <input type="text" id="percentage" />
      <label>Final Result:</label>
      <select id="finalResult">
        <option>Pass</option>
        <option>Fail</option>
      </select>
    </div>

    <button onclick="askPAT()">Upload Result</button>
  </div>

  <script>
    const studentListUrl = 'https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_register.json';
    let selectedStudent = null;
    const subjects = ['Kannada', 'English', 'Hindi', 'Math', 'Science', 'Social'];

    document.getElementById("branch").addEventListener("change", () => {
      document.getElementById("step2").style.display = "block";
    });

    document.getElementById("updaterName").addEventListener("input", () => {
      document.getElementById("step3").style.display = "block";
    });

    document.getElementById("studentClass").addEventListener("change", async () => {
      const cls = document.getElementById("studentClass").value;
      const branch = document.getElementById("branch").value;
      const studentDropdown = document.getElementById("studentName");

      let res = await fetch(studentListUrl);
      let data = await res.json();

      let students = data.filter(st => st.class === cls && st.branch === branch);
      studentDropdown.innerHTML = `<option value="">Select Student</option>`;
      students.forEach(st => {
        studentDropdown.innerHTML += `<option value="${st.regno}">${st.name}</option>`;
      });

      document.getElementById("step4").style.display = "block";
    });

    document.getElementById("studentName").addEventListener("change", async () => {
      const reg = document.getElementById("studentName").value;
      let res = await fetch(studentListUrl);
      let data = await res.json();
      selectedStudent = data.find(st => st.regno === reg);
      if (selectedStudent) {
        document.getElementById("regno").innerText = selectedStudent.regno;
        document.getElementById("step5").style.display = "block";
        showSubjects();
      }
    });

    function showSubjects() {
      const div = document.getElementById("subjects");
      div.innerHTML = "";
      subjects.forEach(sub => {
        div.innerHTML += `
          <div class="subject-box">
            <h4>${sub}</h4>
            <input placeholder="Marks Obtained" type="number" id="${sub}_obt" />
            <input placeholder="Max Marks" type="number" id="${sub}_max" />
            <input placeholder="Internal Marks Obtained" type="number" id="${sub}_intObt" />
            <input placeholder="Internal Max Marks" type="number" id="${sub}_intMax" />
            <input placeholder="Total" type="number" id="${sub}_total" />
            <input placeholder="Grade" id="${sub}_grade" />
            <select id="${sub}_result">
              <option>Pass</option>
              <option>Fail</option>
            </select>
          </div>
        `;
      });
      document.getElementById("marksForm").style.display = "block";
    }

    function askPAT() {
      const pat = prompt("Enter your GitHub Personal Access Token:");
      if (pat) {
        uploadToGitHub(pat);
      }
    }

    async function uploadToGitHub(pat) {
      const allData = {
        updater: document.getElementById("updaterName").value,
        branch: document.getElementById("branch").value,
        class: selectedStudent.class,
        regno: selectedStudent.regno,
        name: selectedStudent.name,
        exam: "FA1",
        subjects: {},
        final: {
          totalMax: document.getElementById("totalMax").value,
          totalObtained: document.getElementById("totalObtained").value,
          grade: document.getElementById("finalGrade").value,
          percentage: document.getElementById("percentage").value,
          result: document.getElementById("finalResult").value
        }
      };

      subjects.forEach(sub => {
        allData.subjects[sub] = {
          obt: document.getElementById(`${sub}_obt`).value,
          max: document.getElementById(`${sub}_max`).value,
          intObt: document.getElementById(`${sub}_intObt`).value,
          intMax: document.getElementById(`${sub}_intMax`).value,
          total: document.getElementById(`${sub}_total`).value,
          grade: document.getElementById(`${sub}_grade`).value,
          result: document.getElementById(`${sub}_result`).value
        };
      });

      const filename = `data/results/${selectedStudent.regno}_FA1.json`;
      const apiURL = `https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filename}`;

      const content = btoa(JSON.stringify(allData, null, 2));

      let sha = null;

      try {
        const check = await fetch(apiURL, {
          headers: {
            Authorization: `token ${pat}`
          }
        });
        const json = await check.json();
        if (json.sha) sha = json.sha;
      } catch (e) {
        console.log("File does not exist. Will create new.");
      }

      const res = await fetch(apiURL, {
        method: "PUT",
        headers: {
          Authorization: `token ${pat}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Result uploaded for ${selectedStudent.name}`,
          content,
          sha
        })
      });

      if (res.ok) {
        alert("✅ Result uploaded successfully!");
      } else {
        alert("❌ Upload failed. Check PAT or permissions.");
      }
    }
  </script>
</body>
</html>
