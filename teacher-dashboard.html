<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; }
    header { background: #003366; color: white; padding: 20px; display:flex; align-items:center; justify-content:space-between; }
    .profile { display:flex; align-items:center; }
    .profile-circle { width:40px; height:40px; border-radius:50%; object-fit:cover; margin-right:10px; }
    nav { background: #0059b3; display:flex; justify-content:center; flex-wrap:wrap; }
    nav a { color:white; padding:14px 20px; text-decoration:none; font-weight:bold; }
    nav a:hover { background:#003366; }
    .container { max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { padding:8px; border:1px solid #ccc; text-align:center; }
    th { background:#e0ebff; }
    input, select, textarea, button { padding:6px; width:100%; margin-top:10px; box-sizing:border-box; }
    button { cursor:pointer; }
    .logout { text-align:center; margin:20px; }
    .logout button { background:#b30000; color:white; border:none; padding:10px 20px; border-radius:6px; }
    .logout button:hover { background:#800000; }
    .welcome { background:#ccf2ff; color:#003366; padding:10px 15px; border-radius:8px; margin:20px auto; max-width:900px; font-weight:bold; }
    @media(max-width:600px){
      table,th,td { font-size:12px; }
      .profile-circle { width:30px; height:30px; }
    }
  </style>
</head>
<body>

<header>
  <div class="profile">
    <img id="teacherPhoto" class="profile-circle" alt="Teacher Photo">
    <span id="usernameDisplay"></span>
  </div>
  <button onclick="logout()">Logout</button>
</header>

<div class="welcome" id="welcomeMsg">Welcome, Teacher!</div>

<nav>
  <a href="#" onclick="markAttendance()">üìÖ Attendance</a>
  <a href="#" onclick="uploadHomework()">üìö Homework</a>
  <a href="#" onclick="uploadOrEditResult()">üßæ Upload/Edit Result</a>
</nav>

<div class="container" id="dashboardContent">
  <p>Select a menu option above to get started.</p>
</div>

<div class="logout">
  <button onclick="logout()">Logout</button>
</div>

<script>
const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
const homeworkAPI = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";
const attendanceAPIBase = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";
const resultsAPIBase = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/results/";

const username = localStorage.getItem("username");
const branch = localStorage.getItem("branch");
document.getElementById("usernameDisplay").innerText = username;

fetch(usersURL).then(r=>r.json()).then(data=>{
  const t = Object.values(data.Teacher || {}).flatMap(o=>Object.values(o)).find(u=>u.name===username);
  const photo = t?.photo?.trim()
    ? "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/" + t.photo.trim()
    : "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/SJVM%20logo%20empowering%20mankind%20without%20background.png";
  document.getElementById("teacherPhoto").src = photo;
  document.getElementById("welcomeMsg").innerText = `Welcome, Teacher ${t?.name || username}!`;
});

function logout(){
  localStorage.clear();
  window.location.href = "userlogin.html";
}

// ----------------- Attendance -----------------
async function markAttendance(){
  const users = await fetch(usersURL).then(r=>r.json()).then(d=>d.Student);
  const classes = Object.keys(users);
  document.getElementById("dashboardContent").innerHTML = `
    <h2>üìÖ Mark Attendance</h2>
    <label>Date:</label><input type="date" id="attDate"><br><br>
    <label>Class:</label><select id="attClass"><option>--Select--</option>${classes.map(c=>`<option>${c}</option>`)}</select><br><br>
    <button onclick="loadAttendance()">Load Students</button>
    <div id="attContent"></div>
  `;
}

async function loadAttendance(){
  const cls = document.getElementById("attClass").value;
  const date = document.getElementById("attDate").value;
  if(!cls || !date) return alert("Select both class and date");

  const response = await fetch(attendanceAPIBase);
  const body = await response.json();
  const content = JSON.parse(atob(body.content));
  const sha = body.sha;

  if (content?.[date]?.[cls]?.[branch]) {
    document.getElementById("attContent").innerHTML = `<p style="color:red;">‚ùå Attendance already submitted for ${cls} on ${date}.</p>`;
    return;
  }

  const students = await fetch(usersURL).then(r=>r.json()).then(d=>d.Student[cls] || {});
  const rows = Object.entries(students)
    .filter(([_, s]) => s.branch === branch)
    .map(([id, s]) => `
      <tr data-id="${id}" id="row_${id}">
        <td>${s.name} (${id})</td>
        <td>
          <select onchange="colorRow(this, 'row_${id}')">
            <option>Present</option>
            <option>Absent</option>
          </select>
        </td>
      </tr>`).join("");

  document.getElementById("attContent").innerHTML = `
    <table><tr><th>Student</th><th>Status</th></tr>${rows}</table>
    <button onclick="submitAttendance('${sha}')">‚úÖ Submit Attendance</button>
    <p id="attStatus"></p>
  `;
}

function colorRow(select, rowId){
  const row = document.getElementById(rowId);
  row.style.backgroundColor = select.value === "Absent" ? "#ffcccc" : "#ccffcc";
}

async function submitAttendance(sha){
  const date = document.getElementById("attDate").value;
  const cls = document.getElementById("attClass").value;
  const token = prompt("Enter GitHub PAT:");
  if (!token) return;

  const rows = document.querySelectorAll('#attContent tr[data-id]');
  const data = {};
  rows.forEach(row => {
    const id = row.getAttribute("data-id");
    const status = row.querySelector("select").value;
    data[id] = status;
  });

  const resp = await fetch(attendanceAPIBase, { headers: { Authorization: `token ${token}` }});
  const body = await resp.json();
  const content = JSON.parse(atob(body.content));
  const newSha = body.sha;

  content[date] = content[date] || {};
  content[date][cls] = content[date][cls] || {};
  content[date][cls][branch] = data;

  await fetch(attendanceAPIBase, {
    method: "PUT",
    headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: `Attendance ${cls} ${date}`,
      content: btoa(JSON.stringify(content, null, 2)),
      sha: newSha
    })
  });

  document.getElementById("attStatus").innerHTML = `‚úÖ Attendance saved successfully.`;
}

// ----------------- Homework -----------------
function uploadHomework(){
  document.getElementById("dashboardContent").innerHTML = `
    <h2>üìö Upload Homework</h2>
    <label>Class:</label><input id="hwClass"><br><br>
    <label>Subject:</label><input id="hwSubject"><br><br>
    <label>Task:</label><textarea id="hwTask" rows="3"></textarea><br><br>
    <label>Due Date:</label><input type="date" id="hwDue"><br><br>
    <button onclick="submitHomework()">Submit Homework</button>
    <p id="hwStatus"></p>
  `;
}

async function submitHomework(){
  const cls = document.getElementById("hwClass").value.trim();
  const sub = document.getElementById("hwSubject").value.trim();
  const task = document.getElementById("hwTask").value.trim();
  const due = document.getElementById("hwDue").value;
  const token = prompt("GitHub PAT:");
  if(!cls||!sub||!task||!due||!token) return alert("Please fill all fields");

  const resp = await fetch(homeworkAPI, { headers: { Authorization: `token ${token}` }});
  const body = await resp.json();
  const content = JSON.parse(atob(body.content));
  const sha = body.sha;

  content[cls] = content[cls] || [];
  content[cls].push({ subject: sub, task, dueDate: due });

  await fetch(homeworkAPI, {
    method: "PUT",
    headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: `Homework ${cls}`,
      content: btoa(JSON.stringify(content, null, 2)),
      sha
    })
  });

  document.getElementById("hwStatus").innerText = "‚úÖ Homework uploaded!";
}

// ----------------- Result -----------------
function uploadOrEditResult(){
  window.location.href = "uploadoreditresult.html";
}
</script>

</body>
</html>
