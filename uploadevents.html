<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Events - SJVM</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
  html, body { height:100%; }
  body { display:flex; flex-direction:column; min-height:100vh; background:linear-gradient(to right,#0f2027,#203a43,#2c5364); color:white; }
  main { flex:1; padding:2rem; }
  h1 { color:#ffd700; margin-bottom:1rem; text-align:center; }
  label { display:block; margin:0.5rem 0 0.2rem 0; }
  input, select, button { padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:none; width:100%; max-width:400px; }
  button { background:#ffd700; color:#000; font-weight:bold; cursor:pointer; }
  #uploadSection { display:none; margin-top:2rem; }
  #pinSection, #tokenSection { text-align:center; }
  #uploadMsg { margin-top:1rem; font-weight:bold; text-align:center; }
  #previewContainer { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:1rem; justify-content:center; }
  .previewImage { width:120px; height:120px; object-fit:cover; border-radius:8px; border:2px solid #ffd700; }
</style>
</head>
<body>

<main>
<h1>Upload Event Images</h1>

<!-- Security PIN -->
<div id="pinSection">
  <label>Enter Security PIN:</label>
  <input type="password" id="pinInput" placeholder="PIN">
  <button onclick="checkPIN()">Submit</button>
  <p id="pinMsg" style="color:red;"></p>
</div>

<!-- GitHub Token -->
<div id="tokenSection" style="display:none;">
  <label>Enter GitHub Access Token:</label>
  <input type="password" id="tokenInput" placeholder="GitHub PAT">
  <button onclick="submitToken()">Submit Token</button>
  <p id="tokenMsg" style="color:red;"></p>
</div>

<!-- Upload Section -->
<div id="uploadSection">
  <label>Select School Branch:</label>
  <select id="branchSelect"></select>

  <label>Select Event:</label>
  <select id="eventSelect"></select>

  <label>Upload Images:</label>
  <input type="file" id="imageInput" multiple accept="image/*" onchange="showPreview()">

  <div id="previewContainer"></div>

  <button onclick="uploadEvent()">Upload Event</button>
  <p id="uploadMsg"></p>
</div>
</main>

<script>
// ---------- Security PIN ----------
let pinTimer = setTimeout(()=>{ window.location.href="index.html"; }, 20000);
function checkPIN(){
  const pin = document.getElementById("pinInput").value;
  if(pin==="091118"){
    clearTimeout(pinTimer);
    document.getElementById("pinSection").style.display="none";
    document.getElementById("tokenSection").style.display="block";
  } else {
    document.getElementById("pinMsg").textContent = "Incorrect PIN!";
  }
}

// ---------- GitHub Token ----------
let githubToken = "";
function submitToken(){
  const token = document.getElementById("tokenInput").value.trim();
  if(token.length===0){ document.getElementById("tokenMsg").textContent="Token required!"; return; }
  githubToken = token;
  document.getElementById("tokenSection").style.display="none";
  document.getElementById("uploadSection").style.display="block";
  loadBranches();
}

// ---------- Load Branches & Events ----------
let eventsData = [];
const username = "Echoesofthe21stcentury"; // GitHub username
const repo = "sjvm-schools";              // GitHub repo
const branch = "main";

async function loadBranches(){
  const res = await fetch('events.json');
  eventsData = await res.json();
  const branchSet = new Set(eventsData.map(e=>e.school));
  const branchSelect = document.getElementById("branchSelect");
  branchSet.forEach(b=>{
    const opt = document.createElement("option"); opt.value=b; opt.textContent=b;
    branchSelect.appendChild(opt);
  });
  branchSelect.addEventListener("change", updateEvents);
  updateEvents();
}

function updateEvents(){
  const selectedBranch = document.getElementById("branchSelect").value;
  const eventSelect = document.getElementById("eventSelect");
  eventSelect.innerHTML="";
  eventsData.filter(e=>e.school===selectedBranch).forEach(ev=>{
    const opt = document.createElement("option"); opt.value=ev.id; opt.textContent=ev.title;
    eventSelect.appendChild(opt);
  });
}

// ---------- Preview Images ----------
function showPreview(){
  const files = document.getElementById("imageInput").files;
  const container = document.getElementById("previewContainer");
  container.innerHTML="";
  Array.from(files).forEach(file=>{
    const img = document.createElement("img");
    img.className="previewImage";
    img.src = URL.createObjectURL(file);
    container.appendChild(img);
  });
}

// ---------- GitHub Upload ----------
async function uploadEvent(){
  const selectedEventId = parseInt(document.getElementById("eventSelect").value);
  const selectedEvent = eventsData.find(e=>e.id===selectedEventId);
  const files = document.getElementById("imageInput").files;
  if(files.length===0){ alert("Select at least one image."); return; }

  const imagesFolder = `images/${selectedEvent.school}/${selectedEvent.title.replace(/\s+/g,"_")}/`;
  const newImagePaths = [];

  for(const file of files){
    const b64 = await toBase64(file);
    const path = `${imagesFolder}${file.name}`;
    newImagePaths.push(path);

    let sha = null;
    const getFile = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}?ref=${branch}`, {
      headers:{Authorization:`token ${githubToken}`}
    });
    if(getFile.ok){
      const fileData = await getFile.json();
      sha = fileData.sha;
    }

    await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
      method:"PUT",
      headers:{Authorization:`token ${githubToken}`},
      body: JSON.stringify({
        message: `Add ${file.name}`,
        content: b64,
        branch: branch,
        sha: sha
      })
    });
  }

  // Update events.json
  selectedEvent.images.push(...newImagePaths);

  const getEventsFile = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/events.json?ref=${branch}`, {
    headers:{Authorization:`token ${githubToken}`}
  });
  const eventsFileData = await getEventsFile.json();
  const eventsSHA = eventsFileData.sha;

  const updateRes = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/events.json`, {
    method:"PUT",
    headers:{Authorization:`token ${githubToken}`},
    body: JSON.stringify({
      message: `Update images for ${selectedEvent.title}`,
      content: btoa(JSON.stringify(eventsData, null, 2)),
      branch: branch,
      sha: eventsSHA
    })
  });

  if(updateRes.ok){
    document.getElementById("uploadMsg").textContent = "Event images uploaded successfully!";
    document.getElementById("previewContainer").innerHTML="";
    document.getElementById("imageInput").value="";
  } else {
    document.getElementById("uploadMsg").textContent = "Error updating events.json.";
    console.error(await updateRes.json());
  }
}

// ---------- Convert file to base64 ----------
function toBase64(file){ 
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=> resolve(reader.result.split(",")[1]);
    reader.onerror = err=> reject(err);
  });
}
</script>
</body>
</html>
