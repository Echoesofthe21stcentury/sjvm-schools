<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Result Upload - SJVM</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins&display=swap">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: white;
      padding: 20px;
    }
    h2 { text-align: center; color: #ffd700; }
    label { font-weight: bold; display: block; margin-top: 15px; }
    select, input, button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      margin-top: 5px;
    }
    button {
      background-color: #ffd700;
      color: black;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
    .subject-block {
      background: #ffffff15;
      padding: 10px;
      margin-top: 10px;
      border-radius: 10px;
    }
    .subject-block.fail {
      background-color: rgba(255, 0, 0, 0.2);
    }
    .subject-block.pass {
      background-color: rgba(0, 255, 0, 0.2);
    }
  </style>
</head>
<body>

<h2>üìò Upload Student Results</h2>

<div id="step1">
  <label>Enter Branch Secret Code:</label>
  <input type="password" id="secretCode" placeholder="e.g., 0903 or 1103" />
  <button onclick="verifyBranch()">Next</button>
</div>

<div id="step2" style="display:none;">
  <label>Updater Name:</label>
  <input type="text" id="updaterName" />
  <button onclick="nextStep()">Next</button>
</div>

<div id="step3" style="display:none;">
  <label>Select Class:</label>
  <select id="classSelect" onchange="loadStudents()"></select>

  <label>Select Student:</label>
  <select id="studentSelect" onchange="autoFillStudent()"></select>

  <label>Register Number:</label>
  <input type="text" id="regNo" disabled />

  <label>Examination:</label>
  <input type="text" id="examName" disabled />
  <button onclick="nextSubjects()">Next</button>
</div>

<div id="step4" style="display:none;">
  <div id="subjectsContainer"></div>
  <button onclick="showFinalStep()">Next</button>
</div>

<div id="step5" style="display:none;">
  <label>Total Max Marks:</label>
  <input type="number" id="totalMax" />

  <label>Total Obtained Marks:</label>
  <input type="number" id="totalObtained" />

  <label>Final Grade:</label>
  <input type="text" id="finalGrade" />

  <label>Result (Pass/Fail):</label>
  <input type="text" id="finalResult" />

  <label>Percentage:</label>
  <input type="text" id="finalPercent" />

  <button onclick="uploadToGitHub()">Upload Result</button>
</div>

<script>
let branch = "";
let studentsData = [];

function verifyBranch() {
  const code = document.getElementById('secretCode').value.trim();
  if (code === "0903") branch = "Atturu Layout";
  else if (code === "1103") branch = "Bandikodigenahalli";
  else return alert("‚ùå Invalid secret code");
  document.getElementById('step1').style.display = "none";
  document.getElementById('step2').style.display = "block";
}

function nextStep() {
  document.getElementById('step2').style.display = "none";
  document.getElementById('step3').style.display = "block";
  fetch('data/student_register.json')
    .then(res => res.json())
    .then(data => {
      studentsData = Object.values(data.Student)
        .flatMap(classes => Object.values(classes))
        .filter(s => s.branch === branch);

      const classes = [...new Set(studentsData.map(s => s.class))];
      const classSelect = document.getElementById('classSelect');
      classes.forEach(cls => {
        const option = document.createElement('option');
        option.textContent = cls;
        option.value = cls;
        classSelect.appendChild(option);
      });
    });
}

function loadStudents() {
  const cls = document.getElementById('classSelect').value;
  const studentSelect = document.getElementById('studentSelect');
  studentSelect.innerHTML = "";
  const filtered = studentsData.filter(s => s.class === cls);
  filtered.forEach(s => {
    const opt = document.createElement('option');
    opt.value = s.register_no;
    opt.textContent = s.name;
    studentSelect.appendChild(opt);
  });
}

function autoFillStudent() {
  const reg = document.getElementById('studentSelect').value;
  const student = studentsData.find(s => s.register_no === reg);
  if (student) {
    document.getElementById('regNo').value = student.register_no;
    document.getElementById('examName').value = student.examination || "NA";
  }
}

function nextSubjects() {
  document.getElementById('step3').style.display = "none";
  document.getElementById('step4').style.display = "block";
  const container = document.getElementById('subjectsContainer');
  const subjects = ["Kannada", "English", "Hindi", "Mathematics", "Science", "Social"];
  subjects.forEach(subject => {
    const block = document.createElement('div');
    block.className = "subject-block";
    block.innerHTML = `
      <label><b>${subject}</b></label>
      <input placeholder="Marks Obtained" type="number" class="mo" />
      <input placeholder="Max Marks" type="number" class="mm" />
      <input placeholder="Internal Obtained" type="number" class="io" />
      <input placeholder="Internal Max" type="number" class="im" />
      <input placeholder="Grade" type="text" class="grade" />
      <select class="result" onchange="colorResult(this)">
        <option value="">--Pass/Fail--</option>
        <option value="Pass">Pass</option>
        <option value="Fail">Fail</option>
      </select>
    `;
    container.appendChild(block);
  });
}

function colorResult(select) {
  const block = select.parentElement;
  block.classList.remove("pass", "fail");
  if (select.value === "Pass") block.classList.add("pass");
  else if (select.value === "Fail") block.classList.add("fail");
}

function showFinalStep() {
  document.getElementById('step4').style.display = "none";
  document.getElementById('step5').style.display = "block";
}

async function uploadToGitHub() {
  const updater = document.getElementById("updaterName").value;
  const student = document.getElementById("studentSelect").selectedOptions[0].text;
  const regNo = document.getElementById("regNo").value;
  const exam = document.getElementById("examName").value;
  const totalMarks = document.getElementById("totalObtained").value;
  const maxMarks = document.getElementById("totalMax").value;
  const percent = document.getElementById("finalPercent").value;
  const finalGrade = document.getElementById("finalGrade").value;
  const finalResult = document.getElementById("finalResult").value;

  const subjects = [...document.querySelectorAll('.subject-block')].map(block => {
    return {
      subject: block.querySelector('label').innerText,
      marks_obtained: block.querySelector('.mo').value,
      max_marks: block.querySelector('.mm').value,
      internal_obtained: block.querySelector('.io').value,
      internal_max: block.querySelector('.im').value,
      grade: block.querySelector('.grade').value,
      result: block.querySelector('.result').value
    };
  });

  const data = {
    name: student,
    register_no: regNo,
    examination: exam,
    branch,
    class: document.getElementById("classSelect").value,
    subjects,
    total_obtained: totalMarks,
    total_max: maxMarks,
    final_grade: finalGrade,
    final_result: finalResult,
    percentage: percent,
    updated_by: updater
  };

  const token = prompt("üîê Enter your GitHub Personal Access Token");
  if (!token) return alert("‚ùå Token required.");

  const path = `data/results/${regNo}_${exam}.json`;
  const url = `https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${path}`;

  try {
    const res = await fetch(url);
    const existing = await res.json();
    var sha = existing.sha;
  } catch { sha = undefined; }

  const commitMsg = `Add result for ${regNo}`;
  const content = btoa(JSON.stringify(data, null, 2));

  const response = await fetch(url, {
    method: "PUT",
    headers: {
      "Authorization": `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: commitMsg,
      content,
      sha
    })
  });

  if (response.ok) {
    alert("‚úÖ Result uploaded successfully!");
    location.reload();
  } else {
    alert("‚ùå Failed to upload result.");
  }
}
</script>

</body>
</html>
