<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teacher Result Upload</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #e6f2ff;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    label, select, input, button {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #007bff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th {
      background: #004080;
      color: white;
    }
    td input {
      width: 100%;
      padding: 5px;
    }
    .status {
      font-weight: bold;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload Student Results</h2>

    <label for="branch">Select Branch</label>
    <select id="branch">
      <option value="" disabled selected>Select Branch</option>
    </select>

    <label for="class">Select Class</label>
    <select id="class">
      <option value="" disabled selected>Select Class</option>
    </select>

    <label for="exam">Enter Exam Name</label>
    <input type="text" id="exam" placeholder="e.g., FA1, FA2, SA1" />

    <label for="pat">GitHub Personal Access Token (PAT)</label>
    <input type="password" id="pat" placeholder="Enter your GitHub PAT" />

    <div id="studentTableContainer"></div>

    <button onclick="uploadResults()">Upload Results</button>
    <p class="status" id="status"></p>
  </div>

  <script>
    let studentData = [];

    async function loadStudents() {
      try {
        const res = await fetch('/data/student_register.json');
        studentData = await res.json();

        const branchSelect = document.getElementById('branch');
        const branches = [...new Set(studentData.map(s => s.branch))];
        branches.forEach(branch => {
          const opt = document.createElement('option');
          opt.value = branch;
          opt.textContent = branch;
          branchSelect.appendChild(opt);
        });

        branchSelect.addEventListener('change', updateClassOptions);
        document.getElementById('class').addEventListener('change', showStudents);
      } catch (err) {
        document.getElementById('status').textContent = '❌ Failed to load student data.';
        document.getElementById('status').style.color = 'red';
      }
    }

    function updateClassOptions() {
      const branch = document.getElementById('branch').value;
      const filtered = studentData.filter(s => s.branch === branch);
      const classes = [...new Set(filtered.map(s => s.class))];

      const classSelect = document.getElementById('class');
      classSelect.innerHTML = '<option value="" disabled selected>Select Class</option>';
      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        classSelect.appendChild(opt);
      });

      showStudents();
    }

    function showStudents() {
      const branch = document.getElementById('branch').value;
      const cls = document.getElementById('class').value;

      const students = studentData.filter(s => s.branch === branch && s.class === cls);
      if (!branch || !cls || students.length === 0) {
        document.getElementById('studentTableContainer').innerHTML = '<p>No students found.</p>';
        return;
      }

      let html = `
        <table>
          <tr>
            <th>Reg No</th>
            <th>Name</th>
            <th>Kannada</th>
            <th>English</th>
            <th>Maths</th>
            <th>Science</th>
            <th>Social</th>
          </tr>
      `;
      students.forEach(s => {
        html += `
          <tr>
            <td>${s.regno}</td>
            <td>${s.name}</td>
            <td><input type="number" id="kannada-${s.regno}" /></td>
            <td><input type="number" id="english-${s.regno}" /></td>
            <td><input type="number" id="maths-${s.regno}" /></td>
            <td><input type="number" id="science-${s.regno}" /></td>
            <td><input type="number" id="social-${s.regno}" /></td>
          </tr>
        `;
      });
      html += '</table>';
      document.getElementById('studentTableContainer').innerHTML = html;
    }

    async function uploadResults() {
      const pat = document.getElementById('pat').value;
      const exam = document.getElementById('exam').value.trim();
      const branch = document.getElementById('branch').value;
      const cls = document.getElementById('class').value;
      const status = document.getElementById('status');

      if (!pat || !branch || !cls || !exam) {
        status.textContent = '⚠️ Please fill all required fields.';
        status.style.color = 'orange';
        return;
      }

      const students = studentData.filter(s => s.branch === branch && s.class === cls);

      const results = students.map(s => ({
        regno: s.regno,
        name: s.name,
        exam: exam,
        class: s.class,
        branch: s.branch,
        marks: {
          kannada: document.getElementById(`kannada-${s.regno}`).value || "0",
          english: document.getElementById(`english-${s.regno}`).value || "0",
          maths: document.getElementById(`maths-${s.regno}`).value || "0",
          science: document.getElementById(`science-${s.regno}`).value || "0",
          social: document.getElementById(`social-${s.regno}`).value || "0"
        }
      }));

      const content = btoa(JSON.stringify(results, null, 2));
      const filePath = `results/${branch}_${cls}_${exam}.json`;

      try {
        const apiUrl = `https://api.github.com/repos/Echoesofthe21tcentury/sjvm-schools/contents/${filePath}`;
        const response = await fetch(apiUrl, {
          method: 'PUT',
          headers: {
            'Authorization': `token ${pat}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            message: `Uploaded ${cls} ${branch} ${exam} result`,
            content: content
          })
        });

        if (response.ok) {
          status.textContent = '✅ Results uploaded successfully!';
          status.style.color = 'green';
        } else {
          const data = await response.json();
          status.textContent = `❌ Upload failed: ${data.message}`;
          status.style.color = 'red';
        }
      } catch (err) {
        status.textContent = `❌ Error uploading: ${err.message}`;
        status.style.color = 'red';
      }
    }

    loadStudents();
  </script>
</body>
</html>
