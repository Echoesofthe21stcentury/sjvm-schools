<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assign Users ‚Äì SJVM</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f8fc;
      padding: 20px;
    }

    h1, h2 {
      color: #003366;
      text-align: center;
    }

    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }

    input, select {
      width: 100%;
      max-width: 400px;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    button {
      margin-top: 20px;
      background: #0059b3;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    button:hover {
      background: #003366;
    }

    textarea {
      margin-top: 20px;
      width: 100%;
      height: 300px;
      padding: 10px;
      font-family: monospace;
      font-size: 14px;
    }

    .qr-container {
      text-align: center;
      margin-top: 20px;
    }

    .qr-container #qrcode {
      margin-bottom: 10px;
    }
  </style>

  <script>
    // Access security
    const role = localStorage.getItem("role");
    const userid = localStorage.getItem("userid");
    const allowed = ["Principal", "Admin", "Chairman"];
    if (!userid || !allowed.includes(role)) {
      alert("Access Denied.");
      window.location.href = "userlogin.html";
    } else {
      if (!sessionStorage.getItem("access_granted")) {
        const code = prompt("üîê Enter Access Code:");
        if (code !== "2011") {
          alert("Incorrect code. Access denied.");
          window.location.href = "userlogin.html";
        } else {
          sessionStorage.setItem("access_granted", "true");
        }
      }
    }
  </script>
</head>
<body>

  <h1>üë§ Assign New User</h1>

  <label for="role">Select Role:</label>
  <select id="role" onchange="toggleClassDropdown()">
    <option value="">-- Select Role --</option>
    <option value="Student">Student</option>
    <option value="Teacher">Teacher</option>
    <option value="Coordinator">Coordinator</option>
    <option value="Admin">Admin</option>
    <option value="Principal">Principal</option>
    <option value="Chairman">Chairman</option>
  </select>

  <div id="classBlock" style="display:none;">
    <label for="class">Select Class (Students only):</label>
    <select id="class">
      <option value="">-- Select Class --</option>
      <option value="PKG">PKG</option>
      <option value="LKG">LKG</option>
      <option value="UKG">UKG</option>
      <option value="Class 1">Class 1</option>
      <option value="Class 2">Class 2</option>
      <option value="Class 3">Class 3</option>
      <option value="Class 4">Class 4</option>
      <option value="Class 5">Class 5</option>
      <option value="Class 6">Class 6</option>
      <option value="Class 7">Class 7</option>
      <option value="Class 8">Class 8</option>
      <option value="Class 9">Class 9</option>
      <option value="Class 10">Class 10</option>
    </select>
  </div>

  <label for="branch">Branch:</label>
  <select id="branch">
    <option value="">-- Select Branch --</option>
    <option value="Bandikodigenahalli">Bandikodigenahalli</option>
    <option value="Atturu Layout">Atturu Layout</option>
  </select>

  <label for="userid">User ID:</label>
  <input type="text" id="userid" placeholder="e.g. STU-001" />

  <label for="name">Full Name:</label>
  <input type="text" id="name" />

  <label for="password">Password:</label>
  <input type="text" id="password" />

  <button onclick="addUser()">‚ûï Add User & Upload</button>

  <h2>üìÅ Preview users.json + QR Login Link</h2>
  <textarea id="jsonOutput" readonly></textarea>

  <div class="qr-container">
    <div id="qrcode"></div>
    <button onclick="window.print()">üñ® Print QR</button>
  </div>

  <script>
    let users = {};

    function toggleClassDropdown() {
      const role = document.getElementById("role").value;
      document.getElementById("classBlock").style.display = role === "Student" ? "block" : "none";
    }

    async function getFileSHA(token) {
      const res = await fetch("https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/users.json", {
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github.v3+json"
        }
      });
      const data = await res.json();
      return data.sha;
    }

    async function uploadUsersJSON(token) {
      const sha = await getFileSHA(token);
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(users, null, 2))));
      const body = {
        message: "üë§ Added user to users.json",
        content,
        sha,
        branch: "main"
      };

      const res = await fetch("https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/users.json", {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify(body)
      });

      if (!res.ok) throw new Error("Upload failed.");
    }

    async function addUser() {
      const role = document.getElementById("role").value;
      const userid = document.getElementById("userid").value.trim();
      const name = document.getElementById("name").value.trim();
      const password = document.getElementById("password").value.trim();
      const userClass = document.getElementById("class").value;
      const branch = document.getElementById("branch").value;

      if (!role || !userid || !name || !password || !branch) {
        alert("Fill all fields.");
        return;
      }

      if (role === "Student" && !userClass) {
        alert("Student class required.");
        return;
      }

      if (!users[role]) users[role] = {};

      if (role === "Student") {
        if (!users[role][userClass]) users[role][userClass] = {};
        users[role][userClass][userid] = { name, password, class: userClass, branch };
      } else {
        users[role][userid] = { name, password, branch };
      }

      const token = prompt("üîë Enter your GitHub Personal Access Token:");
      if (!token) return alert("Token required.");

      try {
        await uploadUsersJSON(token);
        const qrLink = `https://sjvmschools.org/userlogin.html?role=${role}&userid=${userid}${role === "Student" ? `&class=${encodeURIComponent(userClass)}` : ""}`;
        document.getElementById("jsonOutput").value = JSON.stringify(users, null, 2) + `\n\nüîó QR Login Link:\n${qrLink}`;

        // Show QR
        document.getElementById("qrcode").innerHTML = "";
        new QRCode(document.getElementById("qrcode"), {
          text: qrLink,
          width: 200,
          height: 200
        });

        alert("‚úÖ User uploaded & QR generated.");
      } catch (e) {
        alert("‚ùå Error uploading: " + e.message);
      }

      document.getElementById("userid").value = "";
      document.getElementById("name").value = "";
      document.getElementById("password").value = "";
    }
  </script>

</body>
</html>
