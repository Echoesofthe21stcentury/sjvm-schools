<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Upload Student Result</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #e9f0f8;
      padding: 20px;
    }
    .step {
      display: none;
      margin-bottom: 20px;
    }
    .step.active {
      display: block;
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select {
      width: 100%;
      padding: 8px;
    }
    button {
      margin-top: 15px;
      padding: 10px 15px;
      background: #007BFF;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    .subject-box {
      margin-bottom: 20px;
      border: 1px solid #ccc;
      padding: 15px;
      background: #fff;
    }
  </style>
</head>
<body>

<h2>Upload Student Result</h2>

<div id="step-1" class="step active">
  <label>Select Branch</label>
  <select id="branch-select">
    <option value="">-- Choose Branch --</option>
    <option value="Bandikodigenahalli">Bandikodigenahalli</option>
    <option value="Atturu Layout">Atturu Layout</option>
  </select>
  <button onclick="nextStep(2)">Next</button>
</div>

<div id="step-2" class="step">
  <label>Enter Updater Name</label>
  <input type="text" id="updater-name" placeholder="Updater Name" />
  <button onclick="nextStep(3)">Next</button>
</div>

<div id="step-3" class="step">
  <label>Select Class</label>
  <select id="class-select"></select>

  <label>Select Student</label>
  <select id="student-select" onchange="fillStudentDetails()"></select>

  <div id="student-info" style="margin-top: 10px;"></div>

  <button onclick="nextStep(4)">Next</button>
</div>

<div id="step-4" class="step">
  <h3>Enter Subject Marks</h3>
  <div id="subjects"></div>
  <button onclick="nextStep(5)">Next</button>
</div>

<div id="step-5" class="step">
  <h3>Overall Summary</h3>
  <label>Total Marks Obtained</label>
  <input type="number" id="total-obtained" readonly />

  <label>Total Max Marks</label>
  <input type="number" id="total-max" readonly />

  <label>Final Grade</label>
  <input type="text" id="final-grade" readonly />

  <label>Pass/Fail</label>
  <input type="text" id="pass-fail" readonly />

  <label>Percentage</label>
  <input type="text" id="percentage" readonly />

  <button onclick="submitResult()">Upload Result</button>
</div>

<script>
let studentData = [];
let selectedStudent = null;
const subjects = ["Kannada", "English", "Hindi", "Math", "Science", "Social"];

async function loadStudents() {
  try {
    const res = await fetch('data/student_register.json');
    studentData = await res.json();
    const classSelect = document.getElementById('class-select');
    const studentSelect = document.getElementById('student-select');
    const uniqueClasses = [...new Set(studentData.map(s => s.class))];
    classSelect.innerHTML = '<option value="">-- Select Class --</option>';
    uniqueClasses.forEach(cls => {
      const opt = document.createElement('option');
      opt.value = cls;
      opt.textContent = cls;
      classSelect.appendChild(opt);
    });

    classSelect.addEventListener("change", () => {
      const selectedClass = classSelect.value;
      const filtered = studentData.filter(s => s.class === selectedClass);
      studentSelect.innerHTML = '<option value="">-- Select Student --</option>';
      filtered.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name;
        studentSelect.appendChild(opt);
      });
    });
  } catch (e) {
    alert("❌ Failed to load student data.");
    console.error(e);
  }
}

function fillStudentDetails() {
  const studentName = document.getElementById('student-select').value;
  selectedStudent = studentData.find(s => s.name === studentName);
  if (selectedStudent) {
    document.getElementById('student-info').innerHTML = `
      <strong>Reg No:</strong> ${selectedStudent.regno}<br>
      <strong>Exam:</strong> ${selectedStudent.exam}
    `;
  }
}

function nextStep(stepNum) {
  document.querySelectorAll('.step').forEach(div => div.classList.remove('active'));
  document.getElementById('step-' + stepNum).classList.add('active');

  if (stepNum === 3) loadStudents();
  if (stepNum === 4) showSubjectsForm();
  if (stepNum === 5) calculateSummary();
}

function showSubjectsForm() {
  const container = document.getElementById('subjects');
  container.innerHTML = '';
  subjects.forEach(sub => {
    const box = document.createElement('div');
    box.className = 'subject-box';
    box.innerHTML = `
      <strong>${sub}</strong>
      <label>Marks Obtained</label><input type="number" class="obtained" data-sub="${sub}" />
      <label>Max Marks</label><input type="number" class="max" data-sub="${sub}" />
      <label>Internal Marks Obtained</label><input type="number" class="internal-obtained" data-sub="${sub}" />
      <label>Internal Max Marks</label><input type="number" class="internal-max" data-sub="${sub}" />
    `;
    container.appendChild(box);
  });
}

function calculateSummary() {
  const obtainedInputs = document.querySelectorAll('.obtained');
  const maxInputs = document.querySelectorAll('.max');
  let totalObtained = 0, totalMax = 0;
  for (let i = 0; i < obtainedInputs.length; i++) {
    totalObtained += parseInt(obtainedInputs[i].value || 0);
    totalMax += parseInt(maxInputs[i].value || 0);
  }
  const percentage = ((totalObtained / totalMax) * 100).toFixed(2);
  const grade = percentage >= 90 ? 'A+' :
                percentage >= 80 ? 'A' :
                percentage >= 70 ? 'B' :
                percentage >= 60 ? 'C' :
                percentage >= 50 ? 'D' : 'F';
  const result = grade === 'F' ? 'Fail' : 'Pass';

  document.getElementById('total-obtained').value = totalObtained;
  document.getElementById('total-max').value = totalMax;
  document.getElementById('final-grade').value = grade;
  document.getElementById('pass-fail').value = result;
  document.getElementById('percentage').value = percentage + '%';
}

function submitResult() {
  const updater = document.getElementById('updater-name').value;
  const result = {
    updater,
    student: selectedStudent,
    subjects: {},
    totalObtained: document.getElementById('total-obtained').value,
    totalMax: document.getElementById('total-max').value,
    finalGrade: document.getElementById('final-grade').value,
    percentage: document.getElementById('percentage').value,
    passOrFail: document.getElementById('pass-fail').value
  };

  subjects.forEach(sub => {
    result.subjects[sub] = {
      marksObtained: document.querySelector(`.obtained[data-sub="${sub}"]`).value,
      maxMarks: document.querySelector(`.max[data-sub="${sub}"]`).value,
      internalObtained: document.querySelector(`.internal-obtained[data-sub="${sub}"]`).value,
      internalMax: document.querySelector(`.internal-max[data-sub="${sub}"]`).value
    };
  });

  // 🔄 Replace this with GitHub API POST if needed
  console.log("Uploading Result:", result);
  alert("✅ Result Uploaded (simulated). Check console for details.");
}
</script>
</body>
</html>
