<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Result - SJVM</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      margin: 0; padding: 20px;
      background: linear-gradient(to right, #141e30, #243b55);
      color: #fff;
    }
    .container {
      max-width: 600px;
      margin: auto;
      background: rgba(255,255,255,0.05);
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.5);
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    label, select, input, button {
      display: block;
      width: 100%;
      margin-bottom: 15px;
      padding: 10px;
      border-radius: 5px;
      border: none;
    }
    input, select {
      background: #eee;
      color: #000;
    }
    button {
      background: #00c853;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .hidden {
      display: none;
    }
    .subject-box {
      background: #1c2331;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    .fail {
      background-color: #ff5252;
    }
    .pass {
      background-color: #00e676;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>üìä Teacher Result Entry - SJVM</h2>

    <label>Select Branch</label>
    <select id="branch">
      <option value="Atturu">Atturu</option>
      <option value="Bandikodigenahalli">Bandikodigenahalli</option>
    </select>

    <label>Enter Magical Code</label>
    <input type="password" id="magicCode" placeholder="Enter code (e.g. 0903 or 1103)" />

    <button onclick="verifyCode()">Next</button>

    <div id="step2" class="hidden">
      <label>Updater Name</label>
      <input type="text" id="updater" placeholder="Updater's Full Name" />

      <label>Select Class</label>
      <select id="classSelect" onchange="loadStudents()"></select>

      <label>Select Student</label>
      <select id="studentSelect" onchange="loadStudentDetails()"></select>

      <label>Register Number</label>
      <input type="text" id="registerNo" disabled />

      <label>Examination</label>
      <input type="text" id="examName" disabled />

      <div id="subjects"></div>

      <div id="overallSection" class="hidden">
        <h3>üìò Overall Result</h3>
        <label>Total Max Marks</label>
        <input type="number" id="totalMax" />

        <label>Total Marks Obtained</label>
        <input type="number" id="totalObtained" />

        <label>Percentage</label>
        <input type="text" id="percentage" />

        <label>Final Grade</label>
        <input type="text" id="finalGrade" />

        <label>Final Result</label>
        <select id="finalResult">
          <option>Pass</option>
          <option>Fail</option>
        </select>

        <button onclick="uploadResult()">Upload Result</button>
      </div>
    </div>
  </div>

  <script>
    const SUBJECTS = ['Kannada', 'English', 'Hindi', 'Mathematics', 'Science', 'Social'];
    const studentDataUrl = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_register.json";
    let allStudents = {};

    function verifyCode() {
      const branch = document.getElementById("branch").value;
      const code = document.getElementById("magicCode").value;

      const valid = (branch === 'Atturu' && code === '0903') || (branch === 'Bandikodigenahalli' && code === '1103');
      if (valid) {
        document.getElementById("step2").classList.remove("hidden");
        fetchStudents();
      } else {
        alert("‚ùå Invalid magical code");
      }
    }

    async function fetchStudents() {
      const res = await fetch(studentDataUrl);
      allStudents = await res.json();

      const classSelect = document.getElementById("classSelect");
      classSelect.innerHTML = "<option value=''>Select</option>";

      const branch = document.getElementById("branch").value;
      for (let className in allStudents.Student) {
        const students = allStudents.Student[className];
        if (Object.values(students).some(s => s.branch === branch)) {
          classSelect.innerHTML += `<option value="${className}">${className}</option>`;
        }
      }
    }

    function loadStudents() {
      const className = document.getElementById("classSelect").value;
      const branch = document.getElementById("branch").value;
      const studentSelect = document.getElementById("studentSelect");
      studentSelect.innerHTML = "<option value=''>Select Student</option>";

      const students = allStudents.Student[className];
      for (let regNo in students) {
        if (students[regNo].branch === branch) {
          studentSelect.innerHTML += `<option value="${regNo}">${students[regNo].name}</option>`;
        }
      }
    }

    function loadStudentDetails() {
      const regNo = document.getElementById("studentSelect").value;
      const className = document.getElementById("classSelect").value;
      const student = allStudents.Student[className][regNo];

      document.getElementById("registerNo").value = regNo;
      document.getElementById("examName").value = student.examination || "Mid-Term";

      const container = document.getElementById("subjects");
      container.innerHTML = "";
      SUBJECTS.forEach(sub => {
        container.innerHTML += `
          <div class="subject-box" id="box-${sub}">
            <h4>${sub}</h4>
            <label>Max Marks</label><input type="number" id="${sub}-max">
            <label>Marks Obtained</label><input type="number" id="${sub}-ob">
            <label>Internal Max</label><input type="number" id="${sub}-imax">
            <label>Internal Obtained</label><input type="number" id="${sub}-iob">
            <label>Total Marks</label><input type="number" id="${sub}-total">
            <label>Grade</label><input type="text" id="${sub}-grade">
            <label>Pass/Fail</label>
            <select id="${sub}-status" onchange="colorBox('${sub}')">
              <option value="Pass">Pass</option>
              <option value="Fail">Fail</option>
            </select>
          </div>
        `;
      });

      document.getElementById("overallSection").classList.remove("hidden");
    }

    function colorBox(subject) {
      const status = document.getElementById(`${subject}-status`).value;
      const box = document.getElementById(`box-${subject}`);
      box.classList.remove("pass", "fail");
      box.classList.add(status.toLowerCase());
    }

    async function uploadResult() {
      const updater = document.getElementById("updater").value;
      const regNo = document.getElementById("studentSelect").value;
      const className = document.getElementById("classSelect").value;
      const student = allStudents.Student[className][regNo];
      const branch = document.getElementById("branch").value;

      const result = {
        name: student.name,
        regNo: regNo,
        branch: branch,
        class: className,
        examination: student.examination,
        updater: updater,
        subjects: {},
        overall: {
          totalMax: document.getElementById("totalMax").value,
          totalObtained: document.getElementById("totalObtained").value,
          percentage: document.getElementById("percentage").value,
          grade: document.getElementById("finalGrade").value,
          result: document.getElementById("finalResult").value
        }
      };

      SUBJECTS.forEach(sub => {
        result.subjects[sub] = {
          max: document.getElementById(`${sub}-max`).value,
          ob: document.getElementById(`${sub}-ob`).value,
          imax: document.getElementById(`${sub}-imax`).value,
          iob: document.getElementById(`${sub}-iob`).value,
          total: document.getElementById(`${sub}-total`).value,
          grade: document.getElementById(`${sub}-grade`).value,
          status: document.getElementById(`${sub}-status`).value
        };
      });

      const token = prompt("üîê Enter your GitHub Personal Access Token:");
      const filePath = `data/results/${regNo}.json`;

      const response = await fetch(`https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filePath}`, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Result uploaded for ${regNo}`,
          content: btoa(JSON.stringify(result, null, 2)),
          sha: null
        })
      });

      if (response.ok) {
        alert("‚úÖ Result uploaded successfully!");
      } else {
        alert("‚ùå Failed to upload result.");
      }
    }
  </script>
</body>
</html>
