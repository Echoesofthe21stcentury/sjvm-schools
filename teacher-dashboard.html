<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="auth-check.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f8fc;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 20px;
      text-align: center;
    }
    nav {
      background-color: #0059b3;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    nav a {
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      background-color: #003366;
    }
    .container {
      padding: 30px;
      max-width: 900px;
      margin: auto;
      background: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: left;
    }
    th {
      background-color: #003366;
      color: white;
    }
    select, input, textarea, button {
      padding: 10px;
      margin: 10px 5px;
      width: 100%;
      max-width: 400px;
    }
    .logout {
      text-align: center;
      margin-top: 30px;
    }
    .logout button {
      background-color: #b30000;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .logout button:hover {
      background-color: #800000;
    }
  </style>
</head>
<body>
  <header>
    <h1>üë©‚Äçüè´ Welcome to SJVM Teacher Dashboard</h1>
    <p>Branch: <strong><span id="branchName"></span></strong></p>
  </header>

  <nav>
    <a href="#" onclick="loadAttendanceForm()">üìÖ Mark Attendance</a>
    <a href="#" onclick="loadHomeworkForm()">üìö Upload Homework</a>
    <a href="#" onclick="viewCirculars()">üì¢ View Circulars</a>
  </nav>

  <div class="container" id="dashboardContent">
    <p>Welcome! Please select an option from the menu above.</p>
  </div>

  <div class="logout">
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
    const circularsURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/circulars.json";
    const branch = localStorage.getItem("branch");
    document.getElementById("branchName").textContent = branch || "Unknown";

    function logout() {
      localStorage.clear();
      window.location.href = "userlogin.html";
    }

    async function loadAttendanceForm() {
      const res = await fetch(usersURL);
      const data = await res.json();
      const studentData = data["Student"];
      let classOptions = Object.keys(studentData).map(cls => `<option value="${cls}">${cls}</option>`).join("");

      document.getElementById("dashboardContent").innerHTML = `
        <h2>üìÖ Mark Attendance</h2>
        <label>Select Date:</label><input type="date" id="attDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Select Class:</label>
        <select id="attClass">${classOptions}</select>
        <button onclick="generateAttendance()">Load Students</button>
        <form id="attForm"></form>
      `;
    }

    async function generateAttendance() {
      const cls = document.getElementById("attClass").value;
      const res = await fetch(usersURL);
      const data = await res.json();
      const students = data["Student"]?.[cls];
      let html = `<h3>Class: ${cls} | Branch: ${branch}</h3><table><tr><th>Student ID</th><th>Name</th><th>Status</th></tr>`;

      for (let id in students) {
        html += `
          <tr>
            <td>${id}</td>
            <td>${students[id].name}</td>
            <td>
              <select name="${id}">
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
              </select>
            </td>
          </tr>`;
      }

      html += `</table><br><button onclick="submitAttendance(event)">‚úÖ Submit Attendance</button>`;
      document.getElementById("attForm").innerHTML = html;
    }

    async function submitAttendance(e) {
      e.preventDefault();
      const form = document.getElementById("attForm");
      const selects = form.querySelectorAll("select");
      const attendance = {};
      selects.forEach(sel => attendance[sel.name] = sel.value);

      const date = document.getElementById("attDate").value;
      const cls = document.getElementById("attClass").value;
      const token = prompt("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");

      const url = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";
      const headers = {
        Authorization: `token ${token}`,
        Accept: "application/vnd.github.v3+json"
      };

      let data = {};
      let sha = null;

      try {
        const res = await fetch(url, { headers });
        const file = await res.json();
        if (file && file.content) {
          data = JSON.parse(atob(file.content));
          sha = file.sha;
        }
      } catch (err) {
        console.warn("üìÅ attendance.json not found. Creating new.");
      }

      if (!data[date]) data[date] = {};
      if (!data[date][cls]) data[date][cls] = {};
      if (!data[date][cls][branch]) data[date][cls][branch] = {};
      data[date][cls][branch] = attendance;

      const updatedContent = btoa(JSON.stringify(data, null, 2));
      const payload = {
        message: `üìÖ Attendance for ${cls} ${branch} on ${date}`,
        content: updatedContent
      };
      if (sha) payload.sha = sha;

      try {
        const commit = await fetch(url, {
          method: "PUT",
          headers,
          body: JSON.stringify(payload)
        });

        if (commit.ok) {
          alert("‚úÖ Attendance submitted successfully!");
          document.getElementById("attForm").innerHTML = "";
        } else {
          throw new Error("Commit failed");
        }
      } catch (err) {
        alert("‚ùå Error: " + err.message);
      }
    }

    function loadHomeworkForm() {
      document.getElementById("dashboardContent").innerHTML = `
        <h2>üìö Upload Homework</h2>
        <label>Class:</label>
        <select id="hwClass">
          <option value="">-- Select Class --</option>
          ${["PKG","LKG","UKG","Class 1","Class 2","Class 3","Class 4","Class 5","Class 6","Class 7","Class 8","Class 9","Class 10"]
            .map(cls => `<option value="${cls}">${cls}</option>`).join("")}
        </select>
        <label>Subject:</label><input type="text" id="hwSubject">
        <label>Date:</label><input type="date" id="hwDate" value="${new Date().toISOString().split('T')[0]}">
        <label>Description:</label><textarea id="hwDesc"></textarea>
        <button onclick="submitHomework()">üìù Submit Homework</button>
        <p id="hwMsg" style="color:green;"></p>
      `;
    }

    async function submitHomework() {
      const cls = document.getElementById("hwClass").value;
      const subject = document.getElementById("hwSubject").value.trim();
      const date = document.getElementById("hwDate").value;
      const desc = document.getElementById("hwDesc").value.trim();
      const token = prompt("üîê Enter your GitHub PAT to save homework:");
      const homeworkURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";

      if (!cls || !subject || !desc || !date) {
        document.getElementById("hwMsg").textContent = "‚ö†Ô∏è Please fill all fields.";
        return;
      }

      const headers = {
        Authorization: `token ${token}`,
        Accept: "application/vnd.github.v3+json"
      };

      let data = {};
      let sha = null;

      try {
        const res = await fetch(homeworkURL, { headers });
        const file = await res.json();
        if (file && file.content) {
          data = JSON.parse(atob(file.content));
          sha = file.sha;
        }
      } catch (err) {
        console.warn("üìÅ homework.json not found. Creating new.");
      }

      if (!data[cls]) data[cls] = {};
      if (!data[cls][branch]) data[cls][branch] = [];

      data[cls][branch].push({ subject, date, description: desc });

      const updatedContent = btoa(JSON.stringify(data, null, 2));
      const payload = {
        message: `üìö Homework for ${cls} ${branch} on ${date}`,
        content: updatedContent
      };
      if (sha) payload.sha = sha;

      try {
        const commit = await fetch(homeworkURL, {
          method: "PUT",
          headers,
          body: JSON.stringify(payload)
        });

        if (commit.ok) {
          document.getElementById("hwMsg").textContent = "‚úÖ Homework uploaded successfully!";
        } else {
          throw new Error("Commit failed");
        }
      } catch (err) {
        document.getElementById("hwMsg").textContent = "‚ùå Error: " + err.message;
      }
    }

    async function viewCirculars() {
      try {
        const res = await fetch(circularsURL);
        const data = await res.json();
        const circulars = data?.[branch] || [];

        if (circulars.length === 0) {
          document.getElementById("dashboardContent").innerHTML = "<p>No circulars available for this branch.</p>";
          return;
        }

        let html = `<h2>üì¢ Circulars ‚Äì ${branch}</h2><ul>`;
        circulars.forEach(c => {
          html += `<li><strong>${c.date}</strong>: ${c.message}</li>`;
        });
        html += `</ul>`;
        document.getElementById("dashboardContent").innerHTML = html;
      } catch (err) {
        document.getElementById("dashboardContent").innerHTML = `<p>‚ùå Error loading circulars.</p>`;
      }
    }
  </script>
</body>
</html>
