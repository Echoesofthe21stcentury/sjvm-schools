<!DOCTYPE html>
<html>
<head>
  <title>Student Registration - SJVM</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #1b2a41;
      color: white;
      padding: 30px;
    }
    input, select, button {
      padding: 10px;
      margin: 8px;
      width: 300px;
      border-radius: 5px;
      border: none;
    }
    button {
      background-color: #2980b9;
      color: white;
      cursor: pointer;
    }
    .status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>üìò SJVM Student Registration</h2>

  <label>GitHub Token:</label><br>
  <input type="password" id="github_token" placeholder="Paste your GitHub PAT"><br>

  <label>Student Name:</label><br>
  <input type="text" id="student_name"><br>

  <label>Class:</label><br>
  <select id="student_class">
    <option value="">Select Class</option>
    <option>Class 1</option><option>Class 2</option><option>Class 3</option>
    <option>Class 4</option><option>Class 5</option><option>Class 6</option>
    <option>Class 7</option><option>Class 8</option><option>Class 9</option>
    <option>Class 10</option>
  </select><br>

  <label>Register Number:</label><br>
  <input type="text" id="register_number"><br>

  <label>Branch:</label><br>
  <select id="branch">
    <option value="">Select Branch</option>
    <option value="Atturu">Atturu</option>
    <option value="Bandikodigenahalli">Bandikodigenahalli</option>
  </select><br>

  <button onclick="registerStudent()">Register</button>

  <div class="status" id="status_msg"></div>

  <script>
    const repoOwner = 'Echoesofthe21stcentury';
    const repoName = 'sjvm-schools';
    const filePath = 'student_register.json';

    async function registerStudent() {
      const token = document.getElementById('github_token').value.trim();
      const name = document.getElementById('student_name').value.trim();
      const cls = document.getElementById('student_class').value;
      const reg = document.getElementById('register_number').value.trim();
      const branch = document.getElementById('branch').value;

      const statusMsg = document.getElementById('status_msg');
      statusMsg.innerHTML = '‚è≥ Registering...';

      if (!token || !name || !cls || !reg || !branch) {
        statusMsg.innerHTML = '‚ùå Please fill in all fields.';
        return;
      }

      try {
        const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

        // Fetch existing content
        const existing = await fetch(apiUrl, {
          headers: { Authorization: `token ${token}` }
        });

        let content = [];
        let sha = "";

        if (existing.ok) {
          const json = await existing.json();
          sha = json.sha;
          content = JSON.parse(atob(json.content));
        }

        content.push({
          name: name,
          class: cls,
          register_number: reg,
          branch: branch
        });

        // Encode updated content
        const updatedContent = btoa(JSON.stringify(content, null, 2));

        const response = await fetch(apiUrl, {
          method: "PUT",
          headers: {
            Authorization: `token ${token}`,
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            message: `Register student ${name}`,
            content: updatedContent,
            sha: sha
          })
        });

        if (response.ok) {
          statusMsg.innerHTML = '‚úÖ Student registered successfully!';
        } else {
          statusMsg.innerHTML = '‚ùå Failed to register student.';
        }
      } catch (err) {
        console.error(err);
        statusMsg.innerHTML = '‚ùå Error occurred.';
      }
    }
  </script>
</body>
</html>
