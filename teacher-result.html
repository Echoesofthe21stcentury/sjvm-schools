<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload Student Result</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #eef2f5;
      padding: 20px;
    }
    .section {
      margin-bottom: 20px;
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    input, select, button {
      display: block;
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      margin-bottom: 15px;
    }
    label {
      font-weight: bold;
    }
  </style>
</head>
<body>

  <h2>Upload Student Result</h2>

  <div class="section">
    <label for="branch">Select Branch:</label>
    <select id="branch">
      <option value="">--Select--</option>
      <option value="Bandikodigenahalli">Bandikodigenahalli</option>
      <option value="Atturu Layout">Atturu Layout</option>
    </select>

    <label for="updater">Updater Name:</label>
    <input type="text" id="updater" placeholder="Enter teacher/updater name">
    
    <label for="studentClass">Select Class:</label>
    <select id="studentClass">
      <option value="">--Select--</option>
      <option value="Class 6">Class 6</option>
      <option value="Class 7">Class 7</option>
      <option value="Class 8">Class 8</option>
      <!-- Add more -->
    </select>

    <label for="studentName">Select Student:</label>
    <select id="studentName"></select>

    <div id="autoDetails" style="display: none;">
      <p><strong>Register No:</strong> <span id="regno"></span></p>
      <p><strong>Exam:</strong> FA1</p>
    </div>
  </div>

  <div class="section" id="marksSection" style="display:none;">
    <h3>Enter Subject-wise Marks</h3>
    <div id="subjectInputs"></div>
    
    <label for="finalGrade">Final Grade:</label>
    <input type="text" id="finalGrade" placeholder="Enter final grade">

    <label for="finalPassFail">Final Result:</label>
    <select id="finalPassFail">
      <option value="Pass">Pass</option>
      <option value="Fail">Fail</option>
    </select>

    <button onclick="uploadToGitHub()">Upload Result</button>
  </div>

  <script>
    const studentListUrl = 'https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_register.json';
    let selectedStudent = null;
    const subjects = ["Kannada", "English", "Hindi", "Maths", "Science", "Social"];

    document.getElementById("studentClass").addEventListener("change", fetchStudents);
    document.getElementById("branch").addEventListener("change", fetchStudents);
    
    async function fetchStudents() {
      const branch = document.getElementById("branch").value;
      const studentClass = document.getElementById("studentClass").value;
      const studentName = document.getElementById("studentName");
      studentName.innerHTML = "";

      if (!branch || !studentClass) return;

      const res = await fetch(studentListUrl);
      const students = await res.json();
      const filtered = students.filter(s => s.class === studentClass && s.branch === branch);

      studentName.innerHTML = `<option value="">--Select--</option>`;
      filtered.forEach(s => {
        const option = document.createElement("option");
        option.value = s.name;
        option.text = s.name;
        option.dataset.regno = s.regno;
        studentName.appendChild(option);
      });

      studentName.onchange = () => {
        selectedStudent = filtered.find(s => s.name === studentName.value);
        if (selectedStudent) {
          document.getElementById("regno").textContent = selectedStudent.regno;
          document.getElementById("autoDetails").style.display = "block";
          document.getElementById("marksSection").style.display = "block";
          showSubjectInputs();
        }
      };
    }

    function showSubjectInputs() {
      const container = document.getElementById("subjectInputs");
      container.innerHTML = "";
      subjects.forEach(subject => {
        container.innerHTML += `
          <h4>${subject}</h4>
          <label>Marks Obtained</label>
          <input type="number" id="${subject}-mo">
          <label>Max Marks</label>
          <input type="number" id="${subject}-mm">
          <label>Internal Marks Obtained</label>
          <input type="number" id="${subject}-im">
          <label>Internal Max Marks</label>
          <input type="number" id="${subject}-imm">
          <label>Total Marks</label>
          <input type="number" id="${subject}-total">
          <label>Grade</label>
          <input type="text" id="${subject}-grade">
          <label>Result</label>
          <select id="${subject}-passfail">
            <option>Pass</option>
            <option>Fail</option>
          </select>
        `;
      });
    }

    async function uploadToGitHub() {
      const updater = document.getElementById("updater").value;
      const finalGrade = document.getElementById("finalGrade").value;
      const finalPassFail = document.getElementById("finalPassFail").value;

      let resultEntry = {
        regno: selectedStudent.regno,
        name: selectedStudent.name,
        class: selectedStudent.class,
        branch: selectedStudent.branch,
        exam: "FA1",
        updated_by: updater,
        subjects: {},
        finalGrade,
        finalResult: finalPassFail
      };

      subjects.forEach(subject => {
        resultEntry.subjects[subject] = {
          marks_obtained: +document.getElementById(`${subject}-mo`).value,
          max_marks: +document.getElementById(`${subject}-mm`).value,
          internal_obtained: +document.getElementById(`${subject}-im`).value,
          internal_max: +document.getElementById(`${subject}-imm`).value,
          total: +document.getElementById(`${subject}-total`).value,
          grade: document.getElementById(`${subject}-grade`).value,
          result: document.getElementById(`${subject}-passfail`).value
        };
      });

      // Step 1: Get existing results
      const dataFileUrl = 'https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_results.json';
      let existingData = [];
      try {
        const res = await fetch(dataFileUrl);
        existingData = await res.json();
      } catch (e) {
        existingData = [];
      }

      // Add or replace student result
      const idx = existingData.findIndex(e => e.regno === selectedStudent.regno && e.exam === "FA1");
      if (idx > -1) existingData[idx] = resultEntry;
      else existingData.push(resultEntry);

      const updatedContent = JSON.stringify(existingData, null, 2);
      const filePath = 'data/student_results.json';
      const token = 'YOUR_GITHUB_PAT'; // Replace with your GitHub PAT

      // Step 2: Get file SHA
      const shaRes = await fetch(`https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filePath}`, {
        headers: { Authorization: `token ${token}` }
      });
      const shaJson = await shaRes.json();
      const sha = shaJson.sha;

      // Step 3: Push updated file
      const pushRes = await fetch(`https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filePath}`, {
        method: "PUT",
        headers: {
          "Authorization": `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: `Result updated for ${selectedStudent.name}`,
          content: btoa(unescape(encodeURIComponent(updatedContent))),
          sha
        })
      });

      if (pushRes.ok) {
        alert("Result uploaded successfully!");
      } else {
        alert("Error uploading result!");
      }
    }
  </script>

</body>
</html>
