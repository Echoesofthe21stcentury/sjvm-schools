<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Result Upload</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f0f4ff; padding: 20px; color: #333; }
    h2 { color: #002855; }
    select, input, button {
      padding: 10px; margin: 5px 0; width: 100%;
      border: 1px solid #ccc; border-radius: 6px; font-size: 16px;
    }
    .step { display: none; }
    .step.active { display: block; animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
    .subject-row { border-left: 5px solid #ccc; padding: 10px; margin: 10px 0; background: #fff; border-radius: 8px; }
    .pass { border-left-color: green; }
    .fail { border-left-color: red; }
    .btn { background: #005bbb; color: white; border: none; cursor: pointer; }
    .btn:hover { background: #004199; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <h2>üìö Upload Student Result</h2>

  <!-- Step 1: Branch & Code -->
  <div class="step active" id="step1">
    <label>Select Branch:</label>
    <select id="branch">
      <option value="">-- Select --</option>
      <option value="Atturu Layout">Atturu Layout</option>
      <option value="Bandikodigenahalli">Bandikodigenahalli</option>
    </select>
    <label>Enter Magical Code:</label>
    <input type="password" id="code" placeholder="Enter Secret Code">
    <button class="btn" onclick="checkCode()">Next</button>
  </div>

  <!-- Step 2: Updater Info -->
  <div class="step" id="step2">
    <label>Updater Name:</label>
    <input type="text" id="updater" placeholder="Enter your name">
    <button class="btn" onclick="nextStep(3)">Next</button>
  </div>

  <!-- Step 3: Class, Student -->
  <div class="step" id="step3">
    <label>Select Class:</label>
    <select id="classSelect"></select>

    <label>Select Student:</label>
    <select id="studentSelect" onchange="fillExamAndReg()"></select>

    <label>Register No:</label>
    <input type="text" id="regno" disabled>

    <label>Exam:</label>
    <input type="text" id="exam" disabled>

    <button class="btn" onclick="nextStep(4)">Next</button>
  </div>

  <!-- Step 4: Subject-wise Result -->
  <div class="step" id="step4">
    <h3>Enter Subject Marks</h3>
    <div id="subjects"></div>
    <button class="btn" onclick="nextStep(5)">Next</button>
  </div>

  <!-- Step 5: Overall Result -->
  <div class="step" id="step5">
    <h3>Final Result</h3>
    <input placeholder="Total Max Marks" id="totalMax">
    <input placeholder="Total Marks Obtained" id="totalObtained">
    <input placeholder="Grade" id="finalGrade">
    <input placeholder="Percentage" id="percentage">
    <select id="finalResult">
      <option value="Pass">Pass</option>
      <option value="Fail">Fail</option>
    </select>
    <button class="btn" onclick="uploadResult()">üì§ Upload Result</button>
  </div>

  <script>
    let step = 1;
    const studentData = [];
    const subjects = ["Kannada", "English", "Hindi", "Mathematics", "Science", "Social"];

    function nextStep(num) {
      document.getElementById(`step${step}`).classList.remove("active");
      document.getElementById(`step${num}`).classList.add("active");
      step = num;
    }

    function checkCode() {
      const branch = document.getElementById('branch').value;
      const code = document.getElementById('code').value;

      if ((branch === "Atturu Layout" && code === "0903") ||
          (branch === "Bandikodigenahalli" && code === "1103")) {
        nextStep(2);
      } else {
        alert("‚ùå Invalid magical code!");
      }
    }

    // Load student_register.json
    fetch('data/student_register.json')
      .then(res => res.json())
      .then(data => {
        studentData.push(...data);
      });

    // Populate class dropdown
    document.getElementById('branch').addEventListener('change', () => {
      const branch = document.getElementById('branch').value;
      const classSelect = document.getElementById('classSelect');
      classSelect.innerHTML = '';

      const classes = [...new Set(studentData
        .filter(s => s.branch === branch)
        .map(s => s.class))];

      classes.forEach(cls => {
        const opt = document.createElement('option');
        opt.value = cls;
        opt.textContent = cls;
        classSelect.appendChild(opt);
      });
    });

    document.getElementById('classSelect').addEventListener('change', () => {
      const branch = document.getElementById('branch').value;
      const cls = document.getElementById('classSelect').value;
      const studentSelect = document.getElementById('studentSelect');
      studentSelect.innerHTML = '';

      const filtered = studentData.filter(s => s.branch === branch && s.class === cls);
      filtered.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s.name;
        opt.textContent = s.name;
        opt.dataset.regno = s.regno;
        opt.dataset.exam = s.exam;
        studentSelect.appendChild(opt);
      });
    });

    function fillExamAndReg() {
      const selected = document.getElementById('studentSelect').selectedOptions[0];
      if (selected) {
        document.getElementById('regno').value = selected.dataset.regno;
        document.getElementById('exam').value = selected.dataset.exam;
      }
    }

    // Subject input builder
    function buildSubjects() {
      const container = document.getElementById('subjects');
      container.innerHTML = '';
      subjects.forEach(sub => {
        const div = document.createElement('div');
        div.className = 'subject-row';
        div.innerHTML = `
          <h4>${sub}</h4>
          <input placeholder="Max Marks" class="max">
          <input placeholder="Obtained Marks" class="obt">
          <input placeholder="Internal Max" class="intMax">
          <input placeholder="Internal Obt" class="intObt">
          <input placeholder="Grade" class="grade">
          <select class="status" onchange="this.parentNode.className='subject-row ' + (this.value==='Pass'?'pass':'fail')">
            <option>Pass</option><option>Fail</option>
          </select>
        `;
        container.appendChild(div);
      });
    }

    buildSubjects();

    function uploadResult() {
      const regno = document.getElementById('regno').value;
      const exam = document.getElementById('exam').value;
      const updater = document.getElementById('updater').value;
      const totalMax = document.getElementById('totalMax').value;
      const totalObtained = document.getElementById('totalObtained').value;
      const finalGrade = document.getElementById('finalGrade').value;
      const percentage = document.getElementById('percentage').value;
      const finalResult = document.getElementById('finalResult').value;

      const subjectElements = document.querySelectorAll('.subject-row');
      const subjectResults = [];

      subjectElements.forEach(row => {
        subjectResults.push({
          subject: row.querySelector('h4').textContent,
          max: row.querySelector('.max').value,
          obtained: row.querySelector('.obt').value,
          internalMax: row.querySelector('.intMax').value,
          internalObt: row.querySelector('.intObt').value,
          grade: row.querySelector('.grade').value,
          status: row.querySelector('.status').value
        });
      });

      const resultData = {
        regno, exam, updater,
        subjects: subjectResults,
        totalMax, totalObtained,
        finalGrade, percentage, finalResult
      };

      const jsonContent = btoa(unescape(encodeURIComponent(JSON.stringify(resultData, null, 2))));
      const filename = `data/results/${regno}_${exam}.json`;

      const token = prompt("Enter GitHub PAT:");
      fetch(`https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${filename}`, {
        method: "PUT",
        headers: {
          "Content-Type": "application/json",
          "Authorization": "token " + token
        },
        body: JSON.stringify({
          message: `Result uploaded for ${regno} - ${exam}`,
          content: jsonContent
        })
      }).then(res => {
        if (res.ok) {
          alert("‚úÖ Result uploaded successfully!");
        } else {
          alert("‚ùå Failed to upload result.");
        }
      });
    }
  </script>
</body>
</html>
