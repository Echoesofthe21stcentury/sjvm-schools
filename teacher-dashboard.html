<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; padding: 0; }
    header { background: #003366; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
    nav { background: #0059b3; display: flex; justify-content: center; flex-wrap: wrap; }
    nav button { background: transparent; border: none; color: white; font-weight: bold; padding: 14px 20px; cursor: pointer; }
    nav button:hover { background: #003366; }
    .container { max-width: 900px; margin: 20px auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    label, select, input, textarea, button { display: block; width: 100%; margin: 10px 0; padding: 8px; box-sizing: border-box; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #0059b3; color: white; }
    .pass { background: #ccffcc; }
    .fail { background: #ffcccc; }
    .green { color: green; }
    .red { color: red; }
  </style>
</head>
<body>

<header>
  <h2>ðŸ“˜ Teacher Dashboard</h2>
  <button onclick="logout()">Logout</button>
</header>

<nav>
  <button onclick="showAttendance()">ðŸ“… Attendance</button>
  <button onclick="showHomework()">ðŸ“š Homework</button>
  <button onclick="showResult()">ðŸ§¾ Upload/Edit Result</button>
</nav>

<div class="container" id="content">
  <p>Select a feature above to begin.</p>
</div>

<script>
const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
const resultsURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/results.json";
const homeworkURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";
const attendanceURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";

function logout() {
  alert("Logged out.");
  location.href = "userlogin.html";
}

function showAttendance() {
  fetch(usersURL).then(res => res.json()).then(data => {
    const classes = Object.keys(data.Student || {});
    document.getElementById("content").innerHTML = `
      <h3>ðŸ“… Mark Attendance</h3>
      <label>Select Date:</label>
      <input type="date" id="attDate">
      <label>Select Class:</label>
      <select id="attClass">${classes.map(c => `<option value="${c}">${c}</option>`)}</select>
      <button onclick="loadStudents()">Load Students</button>
      <div id="attTable"></div>
    `;
  });
}

function loadStudents() {
  const cls = document.getElementById("attClass").value;
  const date = document.getElementById("attDate").value;
  if (!cls || !date) return alert("Select both date and class");

  fetch(usersURL).then(res => res.json()).then(data => {
    const students = data.Student[cls] || {};
    let rows = '';
    Object.entries(students).forEach(([id, s]) => {
      rows += `<tr><td>${s.name} (${id})</td>
      <td><select><option value="Present">Present</option><option value="Absent">Absent</option></select></td></tr>`;
    });

    document.getElementById("attTable").innerHTML = `
      <table><tr><th>Student</th><th>Status</th></tr>${rows}</table>
      <button onclick="submitAttendance('${cls}', '${date}')">âœ… Submit Attendance</button>
    `;
  });
}

async function submitAttendance(cls, date) {
  const rows = document.querySelectorAll("#attTable table tr");
  const attendance = {};
  rows.forEach((row, i) => {
    if (i === 0) return;
    const id = row.cells[0].textContent.split("(")[1].split(")")[0];
    const status = row.cells[1].querySelector("select").value;
    attendance[id] = status;
  });

  const token = prompt("Enter GitHub Token:");
  const old = await fetch(attendanceURL, { headers: { Authorization: `token ${token}` }}).then(r=>r.json());
  const content = JSON.parse(atob(old.content));
  const sha = old.sha;

  content[date] = content[date] || {};
  content[date][cls] = attendance;

  await fetch(attendanceURL, {
    method: "PUT",
    headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: `Attendance updated for ${cls} on ${date}`,
      content: btoa(JSON.stringify(content, null, 2)),
      sha
    })
  });

  alert("âœ… Attendance saved.");
}

function showHomework() {
  document.getElementById("content").innerHTML = `
    <h3>ðŸ“š Upload Homework</h3>
    <label>Class:</label><input id="hwClass">
    <label>Subject:</label><input id="hwSubject">
    <label>Description:</label><textarea id="hwDesc" rows="4"></textarea>
    <button onclick="submitHomework()">âœ… Submit Homework</button>
  `;
}

async function submitHomework() {
  const cls = document.getElementById("hwClass").value;
  const subject = document.getElementById("hwSubject").value;
  const desc = document.getElementById("hwDesc").value;
  const token = prompt("Enter GitHub Token:");

  if (!cls || !subject || !desc || !token) return alert("Fill all fields");

  const old = await fetch(homeworkURL, { headers: { Authorization: `token ${token}` }}).then(r=>r.json());
  const content = JSON.parse(atob(old.content));
  const sha = old.sha;

  content[cls] = content[cls] || [];
  content[cls].push({ subject, task: desc });

  await fetch(homeworkURL, {
    method: "PUT",
    headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: `Homework for ${cls}`,
      content: btoa(JSON.stringify(content, null, 2)),
      sha
    })
  });

  alert("âœ… Homework saved.");
}

function showResult() {
  fetch(usersURL).then(res => res.json()).then(data => {
    const classes = Object.keys(data.Student || {});
    document.getElementById("content").innerHTML = `
      <h3>ðŸ§¾ Upload/Edit Result</h3>
      <label>Select Class:</label>
      <select id="resClass">${classes.map(c => `<option>${c}</option>`)}</select>
      <label>Exam Type:</label>
      <select id="resExam">
        <option>FA-1</option><option>FA-2</option><option>FA-3</option><option>FA-4</option>
        <option>SA-1</option><option>SA-2</option>
      </select>
      <button onclick="loadResultForm()">ðŸ“„ Load Students</button>
      <div id="resForm"></div>
    `;
  });
}

function loadResultForm() {
  const cls = document.getElementById("resClass").value;
  const exam = document.getElementById("resExam").value;

  fetch(usersURL).then(res => res.json()).then(data => {
    const students = data.Student[cls] || {};
    let html = "";
    Object.entries(students).forEach(([id, s]) => {
      html += `
        <h4>${s.name} (${id})</h4>
        <table>
          <tr><th>Subject</th><th>Written</th><th>Internal</th><th>Total</th><th>Grade</th><th>Result</th></tr>
          ${["Kannada","English","Hindi","Maths","Science","Social"].map(sub => `
            <tr>
              <td>${sub}</td>
              <td><input data-id="${id}" data-sub="${sub}" class="written"></td>
              <td><input data-id="${id}" data-sub="${sub}" class="internal"></td>
              <td><input data-id="${id}" data-sub="${sub}" class="total" readonly></td>
              <td><input data-id="${id}" data-sub="${sub}" class="grade"></td>
              <td>
                <select data-id="${id}" data-sub="${sub}" class="status">
                  <option>Pass</option><option>Fail</option>
                </select>
              </td>
            </tr>`).join("")}
        </table><br>`;
    });
    html += `<button onclick="submitResult('${cls}', '${exam}')">âœ… Save Result</button>`;
    document.getElementById("resForm").innerHTML = html;

    document.querySelectorAll(".written, .internal").forEach(inp => {
      inp.addEventListener("input", () => {
        const id = inp.dataset.id, sub = inp.dataset.sub;
        const w = +document.querySelector(`[data-id="${id}"][data-sub="${sub}"].written`).value || 0;
        const i = +document.querySelector(`[data-id="${id}"][data-sub="${sub}"].internal`).value || 0;
        document.querySelector(`[data-id="${id}"][data-sub="${sub}"].total`).value = w + i;
      });
    });
  });
}

async function submitResult(cls, exam) {
  const token = prompt("GitHub Token:");
  const allStudents = {};

  document.querySelectorAll("h4").forEach(h4 => {
    const id = h4.textContent.match(/\((.*?)\)/)[1];
    allStudents[id] = { exam, class: cls, marks: {}, total: 0 };
  });

  document.querySelectorAll("input.total").forEach(input => {
    const id = input.dataset.id, sub = input.dataset.sub;
    const written = +document.querySelector(`[data-id="${id}"][data-sub="${sub}"].written`).value || 0;
    const internal = +document.querySelector(`[data-id="${id}"][data-sub="${sub}"].internal`).value || 0;
    const grade = document.querySelector(`[data-id="${id}"][data-sub="${sub}"].grade`).value || "-";
    const status = document.querySelector(`[data-id="${id}"][data-sub="${sub}"].status`).value;
    const total = written + internal;

    allStudents[id].marks[sub] = { written, internal, total, grade, status };
    allStudents[id].total += total;
  });

  const old = await fetch(resultsURL, { headers: { Authorization: `token ${token}` }}).then(r=>r.json());
  const content = JSON.parse(atob(old.content));
  const sha = old.sha;

  Object.entries(allStudents).forEach(([id, res]) => {
    content[id] = content[id] || {};
    content[id][exam] = res;
  });

  await fetch(resultsURL, {
    method: "PUT",
    headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: `Results updated for ${cls} - ${exam}`,
      content: btoa(JSON.stringify(content, null, 2)),
      sha
    })
  });

  alert("âœ… Result saved!");
}
</script>

</body>
</html>
