<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Student Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; }
    header { background-color: #003366; color: white; padding: 20px; text-align: center; }
    nav { background: #0059b3; display: flex; justify-content: center; flex-wrap: wrap; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; font-weight: bold; }
    nav a:hover { background: #003366; }
    .container { max-width: 900px; margin: 30px auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    .logout { text-align: center; margin: 30px; }
    .logout button { padding: 10px 20px; background: #b30000; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .logout button:hover { background: #800000; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: center; }
    th { background-color: #e0ebff; }
    #resultOutput button { margin: 10px 5px; padding: 10px 15px; background: #006600; color: white; border: none; border-radius: 5px; cursor: pointer; }
    #resultOutput button:hover { background: #004d00; }
    .profile-pic { width: 100px; height: 100px; border-radius: 50%; object-fit: cover; }
  </style>
</head>
<body>

<header>
  <h1>üéì SJVM Student Dashboard</h1>
</header>

<nav>
  <a href="#" onclick="showProfile()">Profile</a>
  <a href="#" onclick="showAttendance()">Attendance</a>
  <a href="#" onclick="showHomework()">Homework</a>
  <a href="#" onclick="viewResults()">View Results</a>
</nav>

<div class="container" id="dashboardContent">
  <p>Welcome to your dashboard!</p>
</div>

<div class="logout">
  <button onclick="logout()">Logout</button>
</div>

<script>
  const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
  const homeworkURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/homework.json";
  const attendanceURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/attendance.json";
  const resultsBase = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/results/";

  const userid = localStorage.getItem("userid");
  const studentClass = localStorage.getItem("studentClass");
  const branch = localStorage.getItem("branch");

  if (!userid || !studentClass || !branch) {
    document.getElementById("dashboardContent").innerHTML = "<p style='color:red'>‚ùå Access Denied.</p>";
  }

  function logout() {
    localStorage.clear();
    window.location.href = "userlogin.html";
  }

  async function showProfile() {
    const res = await fetch(usersURL);
    const data = await res.json();
    const student = data.Student?.[studentClass]?.[userid];
    if (!student) {
      document.getElementById("dashboardContent").innerHTML = `<p>Student not found.</p>`;
      return;
    }
    document.getElementById("dashboardContent").innerHTML = `
      <h3>üë§ Profile</h3>
      <img src="${student.photo}" class="profile-pic" alt="Student Photo" /><br><br>
      <p><strong>User ID:</strong> ${userid}</p>
      <p><strong>Name:</strong> ${student.name}</p>
      <p><strong>Class:</strong> ${studentClass}</p>
      <p><strong>Branch:</strong> ${branch}</p>
      <p><strong>Date of Birth:</strong> ${student.dob || '‚Äî'}</p>
      <p><strong>Father's Name:</strong> ${student.father || '‚Äî'}</p>
      <p><strong>Mother's Name:</strong> ${student.mother || '‚Äî'}</p>
      <p><strong>Mobile:</strong> ${student.mobile || '‚Äî'}</p>
      <p><strong>Email:</strong> ${student.email || '‚Äî'}</p>
    `;
  }

  async function showAttendance() {
    try {
      const res = await fetch(attendanceURL);
      const data = await res.json();
      let output = `<h3>üìù Attendance</h3><table><tr><th>Date</th><th>Status</th></tr>`;
      let found = false;
      for (let date in data) {
        const record = data[date]?.[studentClass]?.[branch]?.[userid];
        if (record) {
          output += `<tr><td>${date}</td><td>${record}</td></tr>`;
          found = true;
        }
      }
      output += `</table>`;
      if (!found) output = `<p>No attendance found.</p>`;
      document.getElementById("dashboardContent").innerHTML = output;
    } catch {
      document.getElementById("dashboardContent").innerHTML = `<p>Error loading attendance.</p>`;
    }
  }

  async function showHomework() {
    const res = await fetch(homeworkURL);
    const data = await res.json();
    const classHomework = data[studentClass] || [];
    if (classHomework.length > 0) {
      const list = classHomework.map(h => `<li><strong>${h.subject}:</strong> ${h.task} <br>Due: ${h.dueDate}</li>`).join("");
      document.getElementById("dashboardContent").innerHTML = `<h3>üìö Homework</h3><ul>${list}</ul>`;
    } else {
      document.getElementById("dashboardContent").innerHTML = `<p>No homework found for your class.</p>`;
    }
  }

  function viewResults() {
    const exams = ["FA1", "FA2", "SA1", "FA3", "FA4", "SA2"];
    const select = exams.map(e => `<option value="${e}">${e}</option>`).join("");
    document.getElementById("dashboardContent").innerHTML = `
      <h3>üìä View Results</h3>
      <select id="examSelect">
        <option value="">-- Select Exam --</option>
        ${select}
      </select>
      <button onclick="fetchResult()">üîç View Result</button>
      <div id="resultOutput"></div>
    `;
  }

  async function fetchResult() {
    const exam = document.getElementById("examSelect").value;
    const output = document.getElementById("resultOutput");
    if (!exam) return output.innerHTML = "<p style='color:red'>Select exam</p>";
    try {
      const res = await fetch(`${resultsBase}${exam}_${userid}.json`);
      if (!res.ok) throw new Error();
      const data = await res.json();
      const marks = data.marks || {};
      const status = data.status || "Pass";
      const grade = data.final_grade || "-";
      const total = data.totalMarks || 0;
      const max = data.maxMarks || 700;
      const percentage = data.percentage || ((total / max) * 100).toFixed(2);

      const bgColor = status === "Fail" ? "#ffcccc" : "#ccffcc";
      let rows = "";
      for (let sub in marks) {
        if (typeof marks[sub] === "object") {
          rows += `<tr>
            <td>${sub}</td>
            <td>${marks[sub].obtained}</td>
            <td>${marks[sub].maxMarks}</td>
            <td>${marks[sub].internal}</td>
            <td>${marks[sub].internalMax}</td>
            <td>${marks[sub].total}</td>
            <td>${marks[sub].grade}</td>
          </tr>`;
        }
      }

      output.innerHTML = `
        <div style="background:${bgColor};padding:20px;border-radius:10px;" id="resultSection">
          <table>
            <thead>
              <tr>
                <th>Subject</th><th>Obtained</th><th>Max</th>
                <th>Internal</th><th>Max Internal</th><th>Total</th><th>Grade</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
            <tfoot>
              <tr><td colspan="5"><strong>Total Marks</strong></td><td colspan="2">${total}</td></tr>
              <tr><td colspan="5"><strong>Max Marks</strong></td><td colspan="2">${max}</td></tr>
              <tr><td colspan="5"><strong>Percentage</strong></td><td colspan="2">${percentage}%</td></tr>
              <tr><td colspan="5"><strong>Status</strong></td><td colspan="2">${status}</td></tr>
              <tr><td colspan="5"><strong>Grade</strong></td><td colspan="2">${grade}</td></tr>
            </tfoot>
          </table><br>
          <button onclick="printResult()">üñ®Ô∏è Print</button>
          <button onclick="downloadPDF()">‚¨áÔ∏è PDF</button>
        </div>
      `;
    } catch {
      output.innerHTML = `<p style='color:red'>Result not found.</p>`;
    }
  }

  function printResult() {
    const win = window.open('', '', 'height=700,width=900');
    win.document.write(`<html><head><title>Print Result</title>
    <style>
      body { font-family: Arial; padding: 20px; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #333; padding: 10px; text-align: center; }
    </style>
    </head><body>${document.getElementById("resultSection").innerHTML}</body></html>`);
    win.document.close();
    win.print();
  }

  function downloadPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.html(document.getElementById("resultSection"), {
      callback: function (doc) {
        doc.save("Result.pdf");
      },
      x: 10,
      y: 10
    });
  }
</script>

</body>
</html>
