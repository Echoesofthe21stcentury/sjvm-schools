<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SJVM - Teacher Result Upload</title>
  <style>
    body {
      font-family: Arial;
      background: linear-gradient(to right, #4e54c8, #8f94fb);
      color: white;
      padding: 20px;
    }
    .box {
      background: rgba(0, 0, 0, 0.2);
      padding: 20px;
      border-radius: 10px;
      max-width: 700px;
      margin: auto;
    }
    label, select, input {
      display: block;
      width: 100%;
      margin: 10px 0;
      padding: 8px;
    }
    .pass { background-color: #4CAF50; color: white; }
    .fail { background-color: #F44336; color: white; }
    .subject-block {
      background: #ffffff10;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    button {
      background: #ffffff;
      color: #4e54c8;
      border: none;
      padding: 10px 20px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="box">
    <h1>SJVM Result Upload</h1>

    <label>Branch</label>
    <select id="branch">
      <option value="">Select Branch</option>
      <option value="Atturu Layout">Atturu Layout</option>
      <option value="Bandikodigenahalli">Bandikodigenahalli</option>
    </select>

    <label>Enter Magical Code</label>
    <input type="password" id="magicCode" placeholder="Enter code to continue" />
    <button onclick="verifyCode()">Enter</button>

    <div id="resultForm" style="display:none;">
      <label>Select Class</label>
      <select id="classSelect" onchange="loadStudents()"></select>

      <label>Select Student</label>
      <select id="studentSelect" onchange="fillRegister()"></select>

      <label>Register Number</label>
      <input id="regNumber" disabled />

      <label>Exam Type</label>
      <select id="examType">
        <option>FA1</option>
        <option>FA2</option>
        <option>SA1</option>
        <option>FA3</option>
        <option>FA4</option>
        <option>SA2</option>
      </select>

      <h3>Subjects</h3>
      <div id="subjectsContainer"></div>

      <h3>Final Summary</h3>
      <label>Total Marks Obtained</label>
      <input id="totalMarksObtained" type="number" />

      <label>Total Max Marks</label>
      <input id="totalMaxMarks" type="number" />

      <label>Total %</label>
      <input id="percentage" type="text" />

      <label>Final Grade</label>
      <input id="finalGrade" type="text" />

      <label>Final Result (Pass/Fail)</label>
      <input id="finalResult" type="text" />

      <label>Result Uploader Name</label>
      <input id="uploader" placeholder="Enter your name" />

      <label>GitHub Token</label>
      <input id="pat" type="password" placeholder="Enter your GitHub PAT" />

      <button onclick="uploadResult()">Upload Result</button>
    </div>
  </div>

  <script>
    const correctCodes = {
      "Atturu Layout": "0903",
      "Bandikodigenahalli": "1103"
    };

    const subjects = ["Kannada", "English", "Hindi"];

    function verifyCode() {
      const branch = document.getElementById("branch").value;
      const code = document.getElementById("magicCode").value;
      if (correctCodes[branch] === code) {
        document.getElementById("resultForm").style.display = "block";
        loadClasses(branch);
        renderSubjects();
      } else {
        alert("❌ Incorrect Magical Code");
      }
    }

    function loadClasses(branch) {
      fetch('https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_register.json')
        .then(res => res.json())
        .then(data => {
          const classes = new Set();
          Object.values(data).forEach(student => {
            if (student.branch === branch) {
              classes.add(student.class);
            }
          });
          const classSelect = document.getElementById("classSelect");
          classSelect.innerHTML = [...classes].map(cls => `<option value="${cls}">${cls}</option>`).join("");
        });
    }

    function loadStudents() {
      const branch = document.getElementById("branch").value;
      const classVal = document.getElementById("classSelect").value;

      fetch('https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/data/student_register.json')
        .then(res => res.json())
        .then(data => {
          const studentSelect = document.getElementById("studentSelect");
          const filtered = Object.entries(data).filter(([_, s]) => s.class === classVal && s.branch === branch);
          studentSelect.innerHTML = filtered.map(([reg, s]) =>
            `<option value="${reg}" data-name="${s.name}">${s.name}</option>`
          ).join("");
        });
    }

    function fillRegister() {
      const selected = document.getElementById("studentSelect").value;
      document.getElementById("regNumber").value = selected;
    }

    function renderSubjects() {
      const container = document.getElementById("subjectsContainer");
      container.innerHTML = subjects.map(sub => `
        <div class="subject-block" id="${sub}">
          <h4>${sub}</h4>
          <label>Max Marks</label>
          <input type="number" id="${sub}-max" />
          <label>Marks Obtained</label>
          <input type="number" id="${sub}-obtain" />
          <label>Internal Max</label>
          <input type="number" id="${sub}-internal-max" />
          <label>Internal Obtained</label>
          <input type="number" id="${sub}-internal-obtain" />
          <label>Final Grade</label>
          <input id="${sub}-grade" />
          <label>Status</label>
          <select id="${sub}-status">
            <option value="Pass" class="pass">Pass ✅</option>
            <option value="Fail" class="fail">Fail ❌</option>
          </select>
        </div>
      `).join("");
    }

    async function uploadResult() {
      const resultData = {
        studentName: document.getElementById("studentSelect").selectedOptions[0].text,
        regNumber: document.getElementById("regNumber").value,
        class: document.getElementById("classSelect").value,
        branch: document.getElementById("branch").value,
        exam: document.getElementById("examType").value,
        uploader: document.getElementById("uploader").value,
        totalMarksObtained: document.getElementById("totalMarksObtained").value,
        totalMaxMarks: document.getElementById("totalMaxMarks").value,
        percentage: document.getElementById("percentage").value,
        finalGrade: document.getElementById("finalGrade").value,
        finalResult: document.getElementById("finalResult").value,
        subjects: {}
      };

      subjects.forEach(sub => {
        resultData.subjects[sub] = {
          max: document.getElementById(`${sub}-max`).value,
          obtain: document.getElementById(`${sub}-obtain`).value,
          internalMax: document.getElementById(`${sub}-internal-max`).value,
          internalObtain: document.getElementById(`${sub}-internal-obtain`).value,
          grade: document.getElementById(`${sub}-grade`).value,
          status: document.getElementById(`${sub}-status`).value
        };
      });

      const token = document.getElementById("pat").value;
      const path = `data/student_results.json`;
      const url = `https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/${path}`;

      let sha = '';
      let existing = {};

      try {
        const res = await fetch(url, {
          headers: { Authorization: `token ${token}` }
        });
        const json = await res.json();
        if (json.content) {
          existing = JSON.parse(atob(json.content));
          sha = json.sha;
        }
      } catch (e) {
        existing = {};
      }

      existing[resultData.regNumber + '-' + resultData.exam] = resultData;

      const updateRes = await fetch(url, {
        method: 'PUT',
        headers: {
          Authorization: `token ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          message: `Result updated for ${resultData.regNumber}`,
          content: btoa(JSON.stringify(existing, null, 2)),
          sha: sha || undefined
        })
      });

      if (updateRes.ok) {
        alert("✅ Result uploaded successfully!");
      } else {
        alert("❌ Failed to upload result.");
      }
    }
  </script>
</body>
</html>
