<!DOCTYPE html>
<html>
<head>
  <title>Student Registration - SJVM</title>
</head>
<body>
  <h2>SJVM Student Registration Form</h2>

  <form id="studentForm">
    <label>Student Name:</label><br>
    <input type="text" id="name" required><br><br>

    <label>Class:</label><br>
    <input type="text" id="class" required><br><br>

    <label>Register Number:</label><br>
    <input type="text" id="register" required><br><br>

    <label>Branch:</label><br>
    <select id="branch" required>
      <option value="Atturu">Atturu</option>
      <option value="Bandikodigenahalli">Bandikodigenahalli</option>
    </select><br><br>

    <label>GitHub Token (Hidden in prod):</label><br>
    <input type="password" id="token" required><br><br>

    <button type="submit">Register</button>
  </form>

  <div id="message"></div>

  <script>
    document.getElementById("studentForm").addEventListener("submit", async function(e) {
      e.preventDefault();

      const name = document.getElementById("name").value;
      const studentClass = document.getElementById("class").value;
      const register = document.getElementById("register").value;
      const branch = document.getElementById("branch").value;
      const token = document.getElementById("token").value;

      const repoOwner = "Echoesofthe21stcentury";
      const repoName = "sjvm-schools";
      const filePath = "data/student_register.json";
      const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/contents/${filePath}`;

      const newStudent = {
        name: name,
        class: studentClass,
        register_number: register,
        branch: branch
      };

      // Fetch existing content
      const response = await fetch(apiUrl, {
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github.v3+json"
        }
      });

      if (!response.ok) {
        document.getElementById("message").innerHTML = "❌ Failed to load existing student data.";
        return;
      }

      const fileData = await response.json();
      const content = atob(fileData.content); // base64 decode
      const students = JSON.parse(content);

      students.push(newStudent);

      const updatedContent = btoa(JSON.stringify(students, null, 2)); // encode to base64

      const updateResponse = await fetch(apiUrl, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
          message: `Added student ${name}`,
          content: updatedContent,
          sha: fileData.sha
        })
      });

      if (updateResponse.ok) {
        document.getElementById("message").innerHTML = "✅ Student registered successfully!";
        document.getElementById("studentForm").reset();
      } else {
        document.getElementById("message").innerHTML = "❌ Failed to register student.";
      }
    });
  </script>
</body>
</html>
