<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="auth-check.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; }
    header { background-color: #003366; color: white; padding: 20px; text-align: center; }
    nav { background-color: #0059b3; display: flex; justify-content: center; flex-wrap: wrap; }
    nav a {
      color: white; padding: 14px 20px; text-decoration: none; font-weight: bold;
    }
    nav a:hover { background-color: #003366; }
    .container {
      max-width: 900px; margin: 30px auto; background: white;
      padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    input, textarea, select, button {
      display: block; width: 100%; margin-top: 10px; padding: 10px;
    }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { padding: 10px; border: 1px solid #ccc; text-align: left; }
    th { background-color: #003366; color: white; }
    .logout { text-align: center; margin: 30px; }
    .logout button {
      padding: 10px 20px; background: #b30000; color: white;
      border: none; border-radius: 6px; cursor: pointer;
    }
    .logout button:hover { background: #800000; }
  </style>
</head>
<body>
  <header>
    <h1>üë©‚Äçüè´ SJVM Teacher Dashboard</h1>
  </header>

  <nav>
    <a href="#" onclick="showUploadHomework()">Upload Homework</a>
    <a href="#" onclick="showCirculars()">View Circulars</a>
    <a href="#" onclick="loadAttendanceForm()">Mark Attendance</a>
  </nav>

  <div class="container" id="dashboardContent">
    <p>Welcome Teacher! Please select an option.</p>
  </div>

  <div class="logout">
    <button onclick="logout()">Logout</button>
  </div>

  <script>
    const homeworkURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";
    const circularsURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/circulars.json";
    const attendanceURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";
    const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";

    const branch = localStorage.getItem("branch");
    const role = localStorage.getItem("role");
    const userid = localStorage.getItem("userid");

    if (role !== "Teacher" || !branch) {
      alert("Access denied");
      window.location.href = "userlogin.html";
    }

    function logout() {
      localStorage.clear();
      window.location.href = "userlogin.html";
    }

    function showUploadHomework() {
      document.getElementById("dashboardContent").innerHTML = `
        <h3>üìö Upload Homework</h3>
        <form id="hwForm">
          <label>Date</label><input type="date" id="hwDate" required>
          <label>Class</label>
          <select id="hwClass" required>
            <option value="">--Select--</option>
            <option>PKG</option><option>LKG</option><option>UKG</option>
            ${[...Array(10)].map((_,i) => `<option>Class ${i+1}</option>`).join("")}
          </select>
          <label>Subject</label><input type="text" id="hwSubject" required>
          <label>Description</label><textarea id="hwDesc" required></textarea>
          <label>Enter your GitHub PAT</label><input type="password" id="pat" placeholder="Paste GitHub token" required>
          <button type="button" onclick="submitHomework()">üì§ Submit</button>
        </form>
      `;
    }

    async function submitHomework() {
      const date = document.getElementById("hwDate").value;
      const cls = document.getElementById("hwClass").value;
      const subject = document.getElementById("hwSubject").value;
      const description = document.getElementById("hwDesc").value;
      const pat = document.getElementById("pat").value;

      if (!date || !cls || !subject || !description || !pat) return alert("Please fill all fields!");

      const headers = {
        Authorization: `token ${pat}`,
        Accept: "application/vnd.github.v3+json"
      };

      try {
        const res = await fetch(homeworkURL, { headers });
        const file = await res.json();
        const sha = file.sha;
        const content = atob(file.content);
        const data = JSON.parse(content);

        if (!data[cls]) data[cls] = {};
        if (!data[cls][branch]) data[cls][branch] = [];

        data[cls][branch].push({ date, subject, description });

        const updatedContent = btoa(JSON.stringify(data, null, 2));
        const commit = await fetch(homeworkURL, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: `üìö Homework uploaded for ${cls} (${branch})`,
            content: updatedContent,
            sha
          })
        });

        if (commit.ok) {
          alert("‚úÖ Homework uploaded!");
          document.getElementById("hwForm").reset();
        } else {
          alert("‚ùå Failed to upload");
        }
      } catch (err) {
        alert("‚ùå Error: " + err.message);
      }
    }

    async function showCirculars() {
      try {
        const res = await fetch(circularsURL);
        const data = await res.json();
        const list = data?.[branch] || [];

        const content = list.length
          ? list.map(c => `<li><strong>${c.date}</strong>: ${c.message}</li>`).join("")
          : "<p>No circulars found.</p>";

        document.getElementById("dashboardContent").innerHTML = `
          <h3>üì¢ Circulars for ${branch}</h3>
          <ul>${content}</ul>
        `;
      } catch {
        document.getElementById("dashboardContent").innerHTML = "<p>Error loading circulars.</p>";
      }
    }

    // Attendance upload from previous code can be inserted here
    async function loadAttendanceForm() {
      const res = await fetch(usersURL);
      const data = await res.json();
      const studentData = data["Student"];

      let classOptions = Object.keys(studentData).map(cls => `<option value="${cls}">${cls}</option>`).join("");

      document.getElementById("dashboardContent").innerHTML = `
        <h2>üìÖ Mark Attendance</h2>
        <label>Select Date:</label><input type="date" id="attDate" value="${new Date().toISOString().split('T')[0]}"><br>
        <label>Select Class:</label><select id="attClass">${classOptions}</select>
        <button onclick="generateAttendance()">Load Students</button>
        <form id="attForm"></form>
      `;
    }

    async function generateAttendance() {
      const cls = document.getElementById("attClass").value;
      const res = await fetch(usersURL);
      const data = await res.json();
      const students = data["Student"]?.[cls];
      let html = `<h3>Class: ${cls} | Branch: ${branch}</h3><table><tr><th>Student ID</th><th>Name</th><th>Status</th></tr>`;

      for (let id in students) {
        html += `
          <tr>
            <td>${id}</td>
            <td>${students[id].name}</td>
            <td>
              <select name="${id}">
                <option value="Present">Present</option>
                <option value="Absent">Absent</option>
              </select>
            </td>
          </tr>`;
      }

      html += `</table><br><label>GitHub PAT</label><input type="password" id="attPat"><button onclick="submitAttendance(event)">Submit Attendance</button>`;
      document.getElementById("attForm").innerHTML = html;
    }

    async function submitAttendance(e) {
      e.preventDefault();
      const form = document.getElementById("attForm");
      const selects = form.querySelectorAll("select");
      const attendance = {};
      selects.forEach(sel => { attendance[sel.name] = sel.value });

      const date = document.getElementById("attDate").value;
      const cls = document.getElementById("attClass").value;
      const pat = document.getElementById("attPat").value;

      const headers = {
        Authorization: `token ${pat}`,
        Accept: "application/vnd.github.v3+json"
      };

      try {
        const res = await fetch(attendanceURL, { headers });
        const file = await res.json();
        const sha = file.sha;
        const content = atob(file.content);
        let data = JSON.parse(content);

        if (!data[date]) data[date] = {};
        if (!data[date][cls]) data[date][cls] = {};
        if (!data[date][cls][branch]) data[date][cls][branch] = {};

        data[date][cls][branch] = attendance;

        const updatedContent = btoa(JSON.stringify(data, null, 2));
        const commit = await fetch(attendanceURL, {
          method: "PUT",
          headers,
          body: JSON.stringify({
            message: `üìÖ Attendance for ${cls} (${branch}) on ${date}`,
            content: updatedContent,
            sha
          })
        });

        if (commit.ok) {
          alert("‚úÖ Attendance uploaded.");
          document.getElementById("attForm").innerHTML = "";
        } else {
          alert("‚ùå Failed to commit to GitHub.");
        }
      } catch (err) {
        alert("‚ùå Error: " + err.message);
      }
    }
  </script>
</body>
</html>
