<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Upload Events - SJVM</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; font-family:'Poppins',sans-serif; }
  html, body { height:100%; }
  body { display:flex; flex-direction:column; min-height:100vh; background:linear-gradient(to right,#0f2027,#203a43,#2c5364); color:white; }
  main { flex:1; padding:2rem; }
  h1 { color:#ffd700; margin-bottom:1rem; text-align:center; }
  label { display:block; margin:0.5rem 0 0.2rem 0; }
  input, select, button { padding:0.5rem; margin-bottom:1rem; border-radius:5px; border:none; width:100%; max-width:400px; }
  button { background:#ffd700; color:#000; font-weight:bold; cursor:pointer; }
  #uploadSection, #tokenSection { display:none; margin-top:2rem; text-align:center; }
  #previewContainer { display:flex; flex-wrap:wrap; gap:0.5rem; margin-top:1rem; justify-content:center; }
  .previewImage { width:120px; height:120px; object-fit:cover; border-radius:8px; border:2px solid #ffd700; }
  #pinSection { text-align:center; }
</style>
</head>
<body>

<main>
<h1>Upload Event Images</h1>

<!-- PIN Section -->
<div id="pinSection">
  <label>Enter Security PIN:</label>
  <input type="password" id="pinInput" placeholder="PIN">
  <button onclick="checkPIN()">Submit</button>
  <p id="pinMsg" style="color:red;"></p>
</div>

<!-- GitHub Token Section -->
<div id="tokenSection">
  <label>Enter GitHub Access Token:</label>
  <input type="password" id="githubTokenInput" placeholder="PAT">
  <button onclick="submitToken()">Submit Token</button>
  <p id="tokenMsg" style="color:red;"></p>
</div>

<!-- Upload Section -->
<div id="uploadSection">
  <label>Select School Branch:</label>
  <select id="branchSelect"></select>

  <label>Select Event:</label>
  <select id="eventSelect"></select>

  <label>Upload Images:</label>
  <input type="file" id="imageInput" multiple accept="image/*" onchange="showPreview()">

  <div id="previewContainer"></div>

  <button onclick="uploadEvent()">Upload Event</button>
  <p id="uploadMsg"></p>
</div>
</main>

<script>
let pinTimer = setTimeout(()=>{ window.location.href="index.html"; }, 20000);
let githubToken = "";

// -------- Security PIN --------
function checkPIN(){
  const pin = document.getElementById("pinInput").value;
  if(pin==="091118"){
    clearTimeout(pinTimer);
    document.getElementById("pinSection").style.display="none";
    document.getElementById("tokenSection").style.display="block";
  } else {
    document.getElementById("pinMsg").textContent = "Incorrect PIN!";
  }
}

// -------- GitHub Token --------
function submitToken(){
  const tokenInput = document.getElementById("githubTokenInput").value.trim();
  if(tokenInput.length===0){
    document.getElementById("tokenMsg").textContent = "Enter a valid token!";
    return;
  }
  githubToken = tokenInput;
  document.getElementById("tokenSection").style.display="none";
  document.getElementById("uploadSection").style.display="block";
  loadBranches();
}

// -------- Load Branches & Events --------
let eventsData = [];
async function loadBranches(){
  const res = await fetch('events.json');
  eventsData = await res.json();
  const branchSet = new Set(eventsData.map(e=>e.school));
  const branchSelect = document.getElementById("branchSelect");
  branchSet.forEach(b=>{
    const opt = document.createElement("option");
    opt.value=b;
    opt.textContent=b;
    branchSelect.appendChild(opt);
  });
  branchSelect.addEventListener("change", updateEvents);
  updateEvents();
}

function updateEvents(){
  const selectedBranch = document.getElementById("branchSelect").value;
  const eventSelect = document.getElementById("eventSelect");
  eventSelect.innerHTML="";
  eventsData.filter(e=>e.school===selectedBranch).forEach(ev=>{
    const opt = document.createElement("option");
    opt.value=ev.id;
    opt.textContent=ev.title;
    eventSelect.appendChild(opt);
  });
}

// -------- Preview Images --------
function showPreview(){
  const files = document.getElementById("imageInput").files;
  const container = document.getElementById("previewContainer");
  container.innerHTML="";
  Array.from(files).forEach(file=>{
    const img = document.createElement("img");
    img.className="previewImage";
    img.src = URL.createObjectURL(file);
    container.appendChild(img);
  });
}

// -------- Upload Event --------
async function uploadEvent(){
  const selectedEventId = parseInt(document.getElementById("eventSelect").value);
  const selectedEvent = eventsData.find(e=>e.id===selectedEventId);
  const files = document.getElementById("imageInput").files;
  if(files.length===0){ alert("Select at least one image."); return; }
  if(githubToken===""){ alert("Enter GitHub token first!"); return; }

  const username = "Echoesofthe21stcentury";
  const repo = "sjvm-schools";
  const branch = "main";
  const imagesFolder = "images/";
  const newImagePaths = [];

  for(const file of files){
    const b64 = await toBase64(file);
    const path = `${imagesFolder}${file.name}`;
    newImagePaths.push(path);

    let sha = null;
    const getFile = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}?ref=${branch}`, {
      headers:{Authorization:`token ${githubToken}`}
    });
    if(getFile.ok){
      const fileData = await getFile.json();
      sha = fileData.sha;
    }

    await fetch(`https://api.github.com/repos/${username}/${repo}/contents/${path}`, {
      method:"PUT",
      headers:{Authorization:`token ${githubToken}`},
      body: JSON.stringify({
        message: `Add ${file.name}`,
        content: b64,
        branch: branch,
        sha: sha
      })
    });
  }

  selectedEvent.images.push(...newImagePaths);

  const getEventsFile = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/events.json?ref=${branch}`, {
    headers:{Authorization:`token ${githubToken}`}
  });
  const eventsFileData = await getEventsFile.json();
  const eventsSHA = eventsFileData.sha;

  function utf8_to_b64(str){ return window.btoa(unescape(encodeURIComponent(str))); }

  const updateRes = await fetch(`https://api.github.com/repos/${username}/${repo}/contents/events.json`, {
    method:"PUT",
    headers:{Authorization:`token ${githubToken}`},
    body: JSON.stringify({
      message: `Update images for ${selectedEvent.title}`,
      content: utf8_to_b64(JSON.stringify(eventsData, null, 2)),
      branch: branch,
      sha: eventsSHA
    })
  });

  if(updateRes.ok){
    document.getElementById("uploadMsg").textContent = "Event images uploaded and events.json updated!";
    document.getElementById("previewContainer").innerHTML = "";
    document.getElementById("imageInput").value = "";
  } else {
    document.getElementById("uploadMsg").textContent = "Error updating events.json.";
    console.error(await updateRes.json());
  }
}

// Convert file to base64
function toBase64(file){ 
  return new Promise((resolve, reject)=>{
    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = ()=> resolve(reader.result.split(",")[1]);
    reader.onerror = err=> reject(err);
  });
}
</script>
</body>
</html>
