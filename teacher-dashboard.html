<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Teacher Dashboard | SJVM</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="auth-check.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f8fc; margin: 0; }
    header { background: #003366; color: white; padding: 20px; position: relative; }
    .profile-circle { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; vertical-align: middle; margin-right:10px; }
    nav { background: #0059b3; display: flex; justify-content:center; flex-wrap: wrap; }
    nav a { color: white; padding: 14px 20px; text-decoration: none; font-weight: bold; }
    nav a:hover { background: #003366; }
    .container { max-width:900px; margin:20px auto; background:white; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { padding:8px; border:1px solid #ccc; text-align:center; }
    th { background: #e0ebff; }
    input[type=number],select,textarea,input[type=text],input[type=date] { padding:6px; width:100%; box-sizing:border-box; }
    button { padding:10px 15px; margin-top:10px; cursor:pointer; }
    .logout { text-align:center; margin:20px;}
    .logout button { background:#b30000; color:white; border:none; padding:10px 20px; border-radius:6px; }
    .logout button:hover { background:#800000; }
    .welcome { background:#ccf2ff; color:#003366; padding:10px 15px; border-radius:8px; margin: 20px auto; max-width: 900px; font-weight:bold; }
    @media(max-width:600px){
      table,th,td{font-size:12px;}
      .profile-circle{width:30px;height:30px;}
    }
  </style>
</head>
<body>
<header>
  <div style="display:flex; align-items:center;">
    <img id="teacherPhoto" class="profile-circle">
    <span id="usernameDisplay"></span>
  </div>
  <div style="position:absolute; top:15px; right:20px;">
    <button onclick="logout()" style="background: crimson; color:white; border:none; padding:6px 12px; border-radius:5px">Logout</button>
  </div>
</header>

<div class="welcome" id="welcomeMsg">
  Welcome, Teacher üë©‚Äçüè´!
</div>

<nav>
  <a href="#" onclick="markAttendance()">üìÖ Mark Attendance</a>
  <a href="#" onclick="uploadHomework()">üìö Upload Homework</a>
  <a href="#" onclick="uploadResult()">üßæ Upload Result</a>
  <a href="#" onclick="editResult()">‚úèÔ∏è Edit Result</a>
</nav>

<div class="container" id="dashboardContent">
  <p>Select a menu option.</p>
</div>

<div class="logout">
  <button onclick="logout()">Logout</button>
</div>

<script>
  const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
  const resultAPIBase = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/results/";

  const username = localStorage.getItem("username");
  const branch = localStorage.getItem("branch");
  document.getElementById("usernameDisplay").innerText = username;

  fetch(usersURL).then(r=>r.json()).then(data=>{
    const t = Object.values(data.Teacher || {}).flatMap(o=>Object.values(o)).find(u=>u.name===username);
    const photo = t?.photo?.trim() ? 
      "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/" + t.photo.trim() : 
      "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/SJVM%20logo%20empowering%20mankind%20without%20background.png";
    document.getElementById("teacherPhoto").src = photo;

    const welcome = document.getElementById("welcomeMsg");
    welcome.innerText = `Welcome, Teacher ${t?.name || username}! üëã`;
  });

  function logout() {
    localStorage.clear();
    window.location.href = "userlogin.html";
  }

  function markAttendance() {
    document.getElementById("dashboardContent").innerHTML = `
      <h2>üìÖ Mark Attendance</h2>
      <p><em>Feature under development</em></p>
    `;
  }

  function uploadHomework() {
    document.getElementById("dashboardContent").innerHTML = `
      <h2>üìö Upload Homework</h2>
      <p>Coming Soon!</p>
    `;
  }

  function uploadResult(editing = false) {
    fetch(usersURL).then(res => res.json()).then(data => {
      const studentData = data.Student;
      const classList = Object.keys(studentData);
      const options = classList.map(c => `<option>${c}</option>`).join("");

      document.getElementById("dashboardContent").innerHTML = `
        <h2>${editing ? '‚úèÔ∏è Edit' : 'üßæ Upload'} Result</h2>
        <label>Class:</label><select id="classSelect"><option>--Select--</option>${options}</select><br><br>
        <label>Exam:</label><select id="examType"><option>FA1</option><option>FA2</option><option>SA1</option><option>FA3</option><option>FA4</option><option>SA2</option></select><br><br>
        <label>Student:</label><select id="studentSelect"><option>Select class first</option></select><br><br>
        <table><thead><tr><th>Subject</th><th>Obtained</th><th>Max</th><th>Internal</th><th>Max Internal</th><th>Total</th><th>Grade</th></tr></thead>
          <tbody>${["Kannada","English","Hindi","Mathematics","EVS","Science","Social Science"].map(sub=>`
            <tr>
              <td>${sub}</td>
              <td><input type="number" id="ob_${sub}" oninput="calc('${sub}')"></td>
              <td><input type="number" id="max_${sub}" value="80" oninput="calc('${sub}')"></td>
              <td><input type="number" id="int_${sub}" value="20" oninput="calc('${sub}')"></td>
              <td><input type="number" id="maxint_${sub}" value="20" disabled></td>
              <td><input type="number" id="total_${sub}" readonly></td>
              <td><input type="text" id="grade_${sub}"></td>
            </tr>`).join("")}
          </tbody>
        </table><br>
        <label>Status:</label><select id="status"><option>Pass</option><option>Fail</option></select><br><br>
        <button onclick="submitResult()">Publish Result</button>
        <p id="resultStatus"></p>
      `;

      document.getElementById("classSelect").addEventListener("change", e => {
        const cls = e.target.value;
        const students = studentData[cls] || {};
        const sel = document.getElementById("studentSelect");
        sel.innerHTML = Object.entries(students)
          .filter(([id, stu]) => stu.branch === branch)
          .map(([id, stu]) => `<option value="${id}">${stu.name} (${id})</option>`)
          .join("");
      });
    });
  }

  function editResult() {
    uploadResult(true);
  }

  function calc(sub) {
    const ob = +document.getElementById(`ob_${sub}`).value || 0;
    const int = +document.getElementById(`int_${sub}`).value || 0;
    document.getElementById(`total_${sub}`).value = ob + int;
  }

  async function submitResult() {
    const className = document.getElementById("classSelect").value;
    const studentId = document.getElementById("studentSelect").value;
    const examType = document.getElementById("examType").value;
    const status = document.getElementById("status").value;
    const token = prompt("Enter your GitHub Personal Access Token:");

    if (!className || !studentId || !examType || !token) return alert("All fields are required!");

    const subjects = ["Kannada","English","Hindi","Mathematics","EVS","Science","Social Science"];
    let marks = {}, totalMarks = 0, maxMarks = 0;

    for (let sub of subjects) {
      const ob = +document.getElementById(`ob_${sub}`).value || 0;
      const mx = +document.getElementById(`max_${sub}`).value || 0;
      const intl = +document.getElementById(`int_${sub}`).value || 0;
      const grade = document.getElementById(`grade_${sub}`).value || "-";
      const total = ob + intl;

      marks[sub] = {
        Marks: ob,
        Max: mx,
        Internal: intl,
        Total: total,
        Grade: grade
      };

      totalMarks += total;
      maxMarks += mx + 20;
    }

    const percentage = ((totalMarks / maxMarks) * 100).toFixed(2);
    const finalGrade = "‚Äì"; // teacher can assign if needed
    const data = {
      marks: marks,
      Total: totalMarks,
      Max: maxMarks,
      Percentage: percentage,
      Grade: finalGrade,
      Status: status
    };

    const filename = `${examType}_${studentId}.json`;
    const resultFileURL = resultAPIBase + filename;

    const response = await fetch(resultFileURL, { headers: { Authorization: `token ${token}` } });
    const existing = await response.json();
    const sha = existing?.sha;

    await fetch(resultFileURL, {
      method: "PUT",
      headers: { Authorization: `token ${token}` },
      body: JSON.stringify({
        message: `Result for ${studentId} - ${examType}`,
        content: btoa(JSON.stringify(data, null, 2)),
        sha: sha
      })
    });

    document.getElementById("resultStatus").innerText = "‚úÖ Result uploaded successfully!";
  }
</script>

</body>
</html>
