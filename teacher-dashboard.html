<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SJVM Teacher Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f8fc;
      margin: 0;
    }
    header {
      background-color: #003366;
      color: white;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    nav {
      background-color: #0059b3;
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
    }
    nav a {
      color: white;
      padding: 14px 20px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a:hover {
      background-color: #003366;
    }
    .container {
      padding: 30px;
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }
    label, select, textarea, input, button {
      display: block;
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #003366;
      color: white;
      font-weight: bold;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #001d3d;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
    }
    th {
      background-color: #003366;
      color: white;
    }
    .logout {
      position: absolute;
      top: 20px;
      right: 20px;
      background-color: crimson;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
    }
    .present {
      background-color: #d0f0c0;
    }
    .absent {
      background-color: #ffc0cb;
    }
  </style>
</head>
<body>

  <header>
    <h1>üë©‚Äçüè´ SJVM Teacher Dashboard</h1>
    <div>Welcome, <span id="usernameDisplay">Teacher</span> üëã</div>
    <button class="logout" onclick="logout()">Logout</button>
  </header>

  <nav>
    <a href="#" onclick="loadAttendance()">Mark Attendance</a>
    <a href="#" onclick="uploadHomework()">Upload Homework</a>
  </nav>

  <div class="container" id="dashboardContent">
    <p>Select an option from the menu to get started.</p>
  </div>

  <script>
    const usersURL = "https://raw.githubusercontent.com/Echoesofthe21stcentury/sjvm-schools/main/users.json";
    const attendanceURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/attendance.json";
    const homeworkURL = "https://api.github.com/repos/Echoesofthe21stcentury/sjvm-schools/contents/homework.json";

    const username = localStorage.getItem("username");
    const branch = localStorage.getItem("branch");
    const role = localStorage.getItem("role");

    if (role !== "Teacher") {
      alert("Access Denied");
      location.href = "userlogin.html";
    }

    document.getElementById("usernameDisplay").textContent = username;

    // üéâ Confetti only on first login
    if (!sessionStorage.getItem("teacherLoggedIn")) {
      confetti();
      setTimeout(() => document.querySelector("canvas")?.remove(), 3000);
      sessionStorage.setItem("teacherLoggedIn", "true");
    }

    function logout() {
      localStorage.clear();
      location.href = "userlogin.html";
    }

    async function loadAttendance() {
      const res = await fetch(usersURL);
      const data = await res.json();
      const students = data.Student;
      let classOptions = Object.keys(students).map(cls => `<option value="${cls}">${cls}</option>`).join("");

      document.getElementById("dashboardContent").innerHTML = `
        <h3>üìÖ Mark Attendance</h3>
        <label>Select Class:</label>
        <select id="attClass">${classOptions}</select>
        <label>Date:</label>
        <input type="date" id="attDate" value="${new Date().toISOString().split("T")[0]}" />
        <button onclick="showAttendanceForm()">Load Students</button>
        <form id="attForm"></form>
      `;
    }

    async function showAttendanceForm() {
      const cls = document.getElementById("attClass").value;
      const res = await fetch(usersURL);
      const data = await res.json();
      const students = data.Student?.[cls];
      let formHTML = `<table><tr><th>ID</th><th>Name</th><th>Status</th></tr>`;

      for (let id in students) {
        if (students[id].branch === branch) {
          formHTML += `
            <tr>
              <td>${id}</td>
              <td>${students[id].name}</td>
              <td>
                <select name="${id}" onchange="colorRow(this)">
                  <option value="Present">Present</option>
                  <option value="Absent">Absent</option>
                </select>
              </td>
            </tr>
          `;
        }
      }
      formHTML += `</table><br><button onclick="submitAttendance(event)">Submit</button>`;
      document.getElementById("attForm").innerHTML = formHTML;
    }

    function colorRow(select) {
      const row = select.closest("tr");
      row.className = select.value === "Present" ? "present" : "absent";
    }

    async function submitAttendance(e) {
      e.preventDefault();
      const date = document.getElementById("attDate").value;
      const cls = document.getElementById("attClass").value;
      const selects = document.querySelectorAll("#attForm select");
      const token = prompt("üîê GitHub PAT:");

      const res = await fetch(attendanceURL, {
        headers: { Authorization: `token ${token}` }
      });

      const file = await res.json();
      const sha = file.sha;
      const content = JSON.parse(atob(file.content));

      if (!content[date]) content[date] = {};
      if (!content[date][cls]) content[date][cls] = {};
      content[date][cls][branch] = {};

      selects.forEach(sel => {
        content[date][cls][branch][sel.name] = sel.value;
      });

      const updated = btoa(JSON.stringify(content, null, 2));

      const commit = await fetch(attendanceURL, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
          message: `‚úÖ Attendance for ${cls} - ${branch} on ${date}`,
          content: updated,
          sha
        })
      });

      alert(commit.ok ? "‚úÖ Attendance saved!" : "‚ùå Upload failed.");
    }

    function uploadHomework() {
      const today = new Date().toISOString().split("T")[0];
      document.getElementById("dashboardContent").innerHTML = `
        <h3>üìö Upload Homework</h3>
        <label>Class:</label>
        <select id="hwClass">
          <option>PKG</option><option>LKG</option><option>UKG</option>
          ${Array.from({length:10},(_,i)=>`<option>Class ${i+1}</option>`).join("")}
        </select>
        <label>Subject:</label>
        <input type="text" id="subject" />
        <label>Description:</label>
        <textarea id="desc"></textarea>
        <button onclick="submitHomework('${today}')">Upload</button>
      `;
    }

    async function submitHomework(date) {
      const cls = document.getElementById("hwClass").value;
      const subject = document.getElementById("subject").value;
      const desc = document.getElementById("desc").value;
      const token = prompt("üîê GitHub PAT:");

      const res = await fetch(homeworkURL, {
        headers: { Authorization: `token ${token}` }
      });

      const file = await res.json();
      const sha = file.sha;
      const content = JSON.parse(atob(file.content));

      if (!content[cls]) content[cls] = {};
      if (!content[cls][branch]) content[cls][branch] = [];

      content[cls][branch].push({ date, subject, description: desc });

      const updated = btoa(JSON.stringify(content, null, 2));

      const commit = await fetch(homeworkURL, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          Accept: "application/vnd.github.v3+json"
        },
        body: JSON.stringify({
          message: `üìö Homework for ${cls} - ${branch} (${date})`,
          content: updated,
          sha
        })
      });

      alert(commit.ok ? "‚úÖ Homework uploaded!" : "‚ùå Upload failed.");
    }
  </script>
</body>
</html>
